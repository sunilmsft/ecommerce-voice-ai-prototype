<!DOCTYPE html>
<!--
╔════════════════════════════════════════════════════════════════╗
║  PROTOTYPE: eCommerce Voice AI Agent Prototype                ║
║  DO NOT EDIT if you meant to edit another prototype file!      ║
║  Current prototypes in folder:                                 ║
║  • .Opt#1- ai-chat-assistant-prototype-human-first.html ✓THIS  ║
║  • .Hybrid - ai-chat-assistant-prototype.html                  ║
╚════════════════════════════════════════════════════════════════╝
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eCommerce Voice AI Agent prototype | Ask Microsoft</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f3f2f1;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* M365 Page Layout */
        .m365-page {
            width: 100%;
            min-height: 100vh;
        }

        .top-nav {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 0;
            height: 65px;
            display: flex;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .nav-content {
            max-width: 1920px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 36px;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .microsoft-logo {
            display: inline-block;
            height: 48px;
            width: auto;
        }

        .microsoft-logo img {
            height: 100%;
            width: auto;
        }

        .nav-divider {
            color: #e0e0e0;
            font-weight: 300;
            margin: 0;
            display: none;
        }

        .nav-title {
            font-size: 15px;
            color: #262626;
            font-weight: 500;
            white-space: nowrap;
            padding: 0 20px;
            margin: 0;
        }

        .nav-dropdown {
            font-size: 10px;
            margin-left: 4px;
            opacity: 0.6;
        }

        .nav-links {
            display: flex;
            gap: 48px;
            list-style: none;
            margin: 0;
            padding: 0;
            margin-left: 0;
        }

        .nav-links a {
            color: #262626;
            text-decoration: none;
            font-size: 12px;
            padding: 0;
            transition: color 0.2s;
            font-weight: 400;
            white-space: nowrap;
            cursor: pointer;
        }

        .nav-links a:hover {
            color: #0078d4;
        }

        /* Dropdown Menu */
        .nav-item {
            position: relative;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #e0e0e0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.12);
            border-radius: 4px;
            margin-top: 8px;
            z-index: 1000;
            min-width: 900px;
            padding: 24px;
        }

        .dropdown-menu.active {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 32px;
        }

        .dropdown-column h3 {
            font-size: 13px;
            font-weight: 600;
            color: #262626;
            margin-bottom: 12px;
            margin-top: 0;
            padding: 0;
        }

        .dropdown-column a {
            display: block;
            font-size: 13px;
            color: #0078d4;
            text-decoration: none;
            margin-bottom: 10px;
            transition: color 0.2s;
        }

        .dropdown-column a:hover {
            color: #106ebe;
            text-decoration: underline;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .nav-btn {
            padding: 7px 16px;
            font-size: 12px;
            border: none;
            background: transparent;
            color: #262626;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Segoe UI', sans-serif;
            white-space: nowrap;
        }

        .nav-btn:hover {
            color: #0078d4;
        }

        .nav-btn.search-btn {
            padding: 5px 10px;
            opacity: 0.7;
            font-size: 11px;
        }

        .nav-btn.primary {
            background: #0078d4;
            color: white;
            padding: 9px 24px;
            border-radius: 2px;
        }

        .nav-btn.primary:hover {
            background: #106ebe;
        }

        .nav-btn.secondary {
            border: 1px solid #8a8886;
            color: #262626;
            border-radius: 2px;
            padding: 7px 18px;
        }

        .nav-btn.secondary:hover {
            background: #f3f2f1;
        }

        .nav-btn.user-btn {
            padding: 5px 10px;
            font-size: 11px;
        }

        /* Promotion Banner */
        .promo-banner {
            background: #001f3f;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            border-bottom: 1px solid #001a2e;
            position: relative;
        }

        .promo-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 0;
            justify-content: center;
        }

        .promo-text {
            color: #ffffff;
            font-size: 13px;
            margin: 0;
            line-height: 1.4;
            font-weight: 400;
            text-align: center;
            white-space: nowrap;
        }

        .promo-link {
            color: #7dd3fc;
            text-decoration: underline;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            transition: color 0.2s;
            margin-left: 4px;
        }

        .promo-link:hover {
            color: #ffffff;
        }

        .promo-close {
            background: none;
            border: none;
            color: #ffffff;
            cursor: pointer;
            font-size: 18px;
            padding: 0 8px;
            opacity: 0.9;
            transition: opacity 0.2s;
            flex-shrink: 0;
            position: absolute;
            right: 24px;
        }

        .promo-close:hover {
            opacity: 1;
        }

        /* Prototype Context Panel */
        .prototype-context-panel {
            background: linear-gradient(135deg, #ecfdf5 0%, #f0fdfa 45%, #ffffff 100%);
            border: 1px solid #5eead4;
            border-left: 6px solid #0f766e;
            border-radius: 6px;
            padding: 16px 18px;
            margin: 12px 20px;
            max-width: 420px;
            width: auto;
            box-shadow:
                0 2px 6px rgba(15, 118, 110, 0.18),
                0 10px 22px rgba(15, 118, 110, 0.14),
                0 18px 32px rgba(15, 118, 110, 0.10),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background-clip: padding-box;
            position: relative;
            transform: translateY(0);
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }

        .prototype-context-panel:hover {
            box-shadow:
                0 4px 10px rgba(15, 118, 110, 0.20),
                0 14px 28px rgba(15, 118, 110, 0.16),
                0 24px 40px rgba(15, 118, 110, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 0.95);
            transform: translateY(-3px);
        }

        .context-header {
            font-size: 11px;
            color: #f0fdfa;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin: 0 0 8px 0;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: #0f766e;
            border-radius: 999px;
            box-shadow: 0 2px 6px rgba(15, 118, 110, 0.2);
        }

        .context-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .context-actions {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .context-refresh {
            border: 1px solid #ccf0e6;
            background: white;
            color: #0d5d52;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .context-refresh:hover {
            background: #d1fae5;
            border-color: #2dd4bf;
        }

        .context-link {
            border: 1px solid #ccf0e6;
            background: white;
            color: #0d5d52;
            padding: 4px 8px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            transition: all 0.2s;
        }

        .context-link:hover {
            background: #d1fae5;
            border-color: #2dd4bf;
        }

        .context-title {
            font-size: 14px;
            font-weight: 700;
            color: #164e63;
            margin: 0 0 6px 0;
        }

        .context-description {
            font-size: 12px;
            color: #0d5d52;
            line-height: 1.4;
            margin: 0 0 12px 0;
        }

        .context-divider {
            height: 1px;
            background: #ccf0e6;
            margin: 10px 0;
        }

        .variant-switcher {
            display: flex;
            gap: 10px;
            flex-wrap: nowrap;
            justify-content: space-between;
            width: 100%;
        }

        .variant-btn {
            flex: 1 1 0;
            padding: 6px 0;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid #5eead4;
            background: white;
            color: #0d5d52;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            text-align: center;
            white-space: nowrap;
        }

        .variant-btn:hover {
            border-color: #2dd4bf;
            background: #d1fae5;
        }

        .variant-btn.active {
            background: #14b8a6;
            color: white;
            border-color: #14b8a6;
        }

        .variant-btn.active:hover {
            background: #0d9488;
            border-color: #0d9488;
        }

        /* Prototype Variant Confirmation Modal */
        .variant-confirmation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .variant-confirmation-modal.active {
            display: flex;
        }

        .variant-confirmation-modal-content {
            background: white;
            border-radius: 8px;
            padding: 28px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 10px 32px rgba(0, 0, 0, 0.15);
            animation: slideUp 0.3s ease-out;
        }

        .variant-confirmation-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 12px 0;
        }

        .variant-confirmation-text {
            font-size: 14px;
            color: #4b5563;
            line-height: 1.6;
            margin: 0 0 20px 0;
        }

        .variant-confirmation-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .variant-confirmation-btn {
            padding: 10px 18px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .variant-confirmation-btn.cancel {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .variant-confirmation-btn.cancel:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }

        .variant-confirmation-btn.confirm {
            background: #14b8a6;
            color: white;
            border: none;
        }

        .variant-confirmation-btn.confirm:hover {
            background: #0d9488;
        }

        .page-content {
            max-width: 1920px;
            margin: 0 auto;
            padding: 60px 20px;
        }

        .hero-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            align-items: center;
            margin-bottom: 80px;
        }

        .hero-text {
            max-width: 600px;
        }

        .discount-badge {
            background: #ffb900;
            color: #000;
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 16px;
        }

        .hero-title {
            font-size: 46px;
            font-weight: 600;
            color: #262626;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .hero-description {
            font-size: 15px;
            color: #262626;
            line-height: 1.5;
            margin-bottom: 24px;
        }

        .hero-buttons {
            display: flex;
            gap: 12px;
        }

        .hero-cta {
            padding: 11px 24px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            font-family: 'Segoe UI', sans-serif;
            transition: all 0.2s;
        }

        .hero-cta.primary {
            background: #0078d4;
            color: white;
        }

        .hero-cta.primary:hover {
            background: #106ebe;
        }

        .hero-cta.secondary {
            background: transparent;
            color: #0078d4;
            border: 1px solid #0078d4;
        }

        .hero-cta.secondary:hover {
            background: #f3f2f1;
        }

        .hero-image {
            position: relative;
            height: 400px;
            background: linear-gradient(135deg, #e6f4ff 0%, #d4ebff 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
        }

        .section-title {
            font-size: 32px;
            font-weight: 600;
            color: #262626;
            text-align: center;
            margin-bottom: 16px;
        }

        .section-description {
            font-size: 15px;
            color: #262626;
            text-align: center;
            max-width: 800px;
            margin: 0 auto 40px;
            line-height: 1.5;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .card {
            background: white;
            padding: 24px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .card-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 15px;
            font-weight: 600;
            color: #262626;
            margin-bottom: 8px;
        }

        .chat-container {
            width: 450px;
            max-width: 450px;
            height: 100vh;
            background: #f3f9ff;
            border-radius: 16px 0 0 16px;
            border: 1px solid #d7e7f5;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: fixed;
            top: 0;
            right: 0;
            z-index: 1000;
        }

        .chat-header {
            background: white;
            border-bottom: 1px solid #e5eef8;
            color: #1b1b1b;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            position: relative;
            z-index: 20;
            min-height: 56px;
            box-shadow: 0 3px 8px rgba(15, 108, 189, 0.12);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .agent-avatar {
            width: 69px;
            height: 69px;
            border-radius: 10px;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .agent-avatar img {
            width: 43px;
            height: 43px;
            display: block;
            object-fit: contain;
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-size: 22px;
            font-weight: 600;
            color: #1b1b1b;
        }

        .agent-status {
            font-size: 12px;
            color: #605e5c;
            margin-top: 2px;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            color: #0f6cbd;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: background 0.2s;
            position: relative;
            z-index: 30;
        }

        .close-btn:hover {
            background: #e8f2ff;
        }

        .minimize-btn {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            color: #0f6cbd;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: background 0.2s;
            position: relative;
            z-index: 30;
        }

        .minimize-btn:hover {
            background: #e8f2ff;
        }

        .chat-container.minimized {
            height: 56px;
            top: auto;
            bottom: 20px;
            right: 20px;
            border-radius: 16px;
            overflow: hidden;
        }

        .chat-container.minimized .chat-messages,
        .chat-container.minimized .handoff-banner,
        .chat-container.minimized .quick-actions,
        .chat-container.minimized .disclaimer,
        .chat-container.minimized .chat-input-area {
            display: none;
        }

        .chat-fab {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            height: 50px;
            background: white;
            color: #262626;
            border: 1px solid #d2d0ce;
            border-radius: 24px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            z-index: 999;
            padding: 0 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .chat-fab:hover {
            background: #f9f9f9;
            border-color: #c5c3c0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .chat-fab-icon {
            width: 28px;
            height: 28px;
            background: #0078d4;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
        }

        .chat-fab-text {
            flex: 1;
            white-space: nowrap;
            font-size: 14px;
            color: #262626;
        }

        .chat-fab-button {
            width: 28px;
            height: 28px;
            background: #0078d4;
            border: none;
            border-radius: 4px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            flex-shrink: 0;
            padding: 0;
            transition: background 0.2s;
        }

        .chat-fab-button:hover {
            background: #106ebe;
        }

        .chat-fab.hidden {
            display: none;
        }

        .chat-fab.visible {
            display: flex;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px 16px 8px;
            background: #f3f9ff;
        }

        .message {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-items: flex-end;
        }

        .message-bubble {
            max-width: 92%;
            padding: 16px;
            border-radius: 16px;
            position: relative;
            font-size: 14.5px;
            line-height: 1.6;
            background: white;
            border: 1px solid #d7e7f5;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        }

        .message.bot .message-bubble {
            background: white;
            color: #1b1b1b;
            border: 1px solid #d7e7f5;
        }
        
        /* Special styling for bot messages with options */
        .message.bot.with-options .message-bubble {
            max-width: 95%;
            padding: 16px;
        }

        .message.user .message-bubble {
            background: #0f6cbd;
            color: white;
            border: none;
            box-shadow: none;
        }

        .message.system .message-bubble {
            background: #fff4ce;
            border: 1px solid #ffb900;
            color: #323130;
            max-width: 90%;
            margin: 0 auto;
            text-align: center;
            font-size: 13px;
        }

        .message.system.web-search .message-bubble {
            background: #e1f5fe;
            border: 1px solid #0078d4;
            color: #323130;
        }

        .message.human-agent .message-bubble {
            background: #e1f5fe;
            border: 1px solid #0078d4;
            color: #323130;
        }

        .message-time {
            font-size: 11px;
            color: #7a8998;
            margin-top: 8px;
        }

        .message-bubble a {
            color: #0f6cbd;
            text-decoration: underline;
        }

        .message.user .message-time {
            text-align: right;
        }

        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: #f3f2f1;
            border: 1px solid #edebe9;
            border-radius: 4px;
            width: fit-content;
        }

        .typing-indicator.active {
            display: block;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #8a8886;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        .quick-actions {
            padding: 12px 20px;
            background: white;
            border-top: 1px solid #edebe9;
            display: flex;
            gap: 8px;
            overflow-x: auto;
        }

        .quick-action-btn {
            padding: 6px 12px;
            background: white;
            border: 1px solid #8a8886;
            color: #323130;
            border-radius: 2px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            transition: all 0.2s;
            font-family: 'Segoe UI', sans-serif;
        }

        .quick-action-btn:hover {
            background: #f3f2f1;
            border-color: #323130;
        }

        .disclaimer {
            padding: 8px 16px;
            background: #f3f9ff;
            border-top: 1px solid #e5eef8;
            font-size: 11px;
            color: #5c6f82;
            text-align: center;
            line-height: 16px;
        }

        .chat-input-area {
            padding: 12px 16px 16px;
            background: #f3f9ff;
            border-top: 1px solid #e5eef8;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 12px 14px;
            border: 1px solid #c9def5;
            border-radius: 12px;
            font-size: 14.5px;
            font-family: 'Segoe UI', sans-serif;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            resize: none;
            min-height: 40px;
            max-height: 120px;
            background: white;
        }

        .chat-input:focus {
            border-color: #0f6cbd;
            box-shadow: 0 0 0 2px rgba(15, 108, 189, 0.15);
        }

        .chat-input::placeholder {
            color: #a19f9d;
        }

        .send-button {
            width: 40px;
            height: 40px;
            background: #0f6cbd;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            font-size: 18px;
            flex-shrink: 0;
        }

        .send-button:hover {
            background: #0b5cab;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .handoff-banner {
            display: none;
            padding: 12px 20px;
            background: #e1f5fe;
            border-left: 3px solid #0078d4;
            margin: 0 20px 12px;
            font-size: 13px;
            color: #323130;
        }

        .handoff-banner.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .feedback-buttons {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .feedback-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            transition: transform 0.2s;
            opacity: 0.6;
        }

        .feedback-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* Scrollbar styling */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .choice-modal {
            background: white;
            border-radius: 4px;
            padding: 24px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 6.4px 14.4px rgba(0, 0, 0, 0.13), 0 1.2px 3.6px rgba(0, 0, 0, 0.11);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #323130;
            margin-bottom: 8px;
        }

        .modal-subtitle {
            font-size: 14px;
            color: #605e5c;
        }

        .choice-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .choice-card {
            border: 1px solid #edebe9;
            border-radius: 2px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: start;
            gap: 12px;
        }

        .choice-card:hover {
            border-color: #0078d4;
            background: #f3f2f1;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .choice-card-icon {
            font-size: 32px;
            flex-shrink: 0;
        }

        .choice-card-content {
            flex: 1;
        }

        .choice-card-title {
            font-size: 15px;
            font-weight: 600;
            color: #323130;
            margin-bottom: 4px;
        }

        .choice-card-description {
            font-size: 13px;
            color: #605e5c;
            line-height: 1.5;
        }

        .modal-cancel {
            width: 100%;
            padding: 10px;
            background: white;
            border: 1px solid #8a8886;
            border-radius: 2px;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Segoe UI', sans-serif;
            color: #323130;
            transition: all 0.2s;
        }

        .modal-cancel:hover {
            background: #f3f2f1;
            border-color: #323130;
        }

        /* Call Screen */
        .call-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0078d4 0%, #00bcf2 100%);
            z-index: 2000;
            flex-direction: column;
            color: white;
            animation: fadeIn 0.3s ease-out;
        }

        .call-screen.active {
            display: flex;
        }

        .call-screen-header {
            padding: 20px;
            text-align: center;
            background: rgba(0, 0, 0, 0.1);
        }

        .call-screen-header h3 {
            font-size: 16px;
            font-weight: 600;
            opacity: 0.9;
        }

        .call-screen-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 40px 20px 20px;
            overflow-y: auto;
        }

        .call-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .call-avatar img {
            width: 84px;
            height: 84px;
            object-fit: cover;
            border-radius: 50%;
            filter: grayscale(1) sepia(1) hue-rotate(200deg) saturate(3) brightness(0.65) contrast(1.1);
        }

        .call-info {
            text-align: center;
            margin-bottom: 32px;
        }

        .call-agent-name {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .call-status {
            font-size: 15px;
            opacity: 0.9;
        }

        .call-status.connecting {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .call-timer {
            font-size: 16px;
            opacity: 0.9;
            margin-top: 12px;
        }

        .call-transcript-area {
            width: 100%;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        .call-transcript-area.active {
            display: block;
        }

        .call-transcript-entry {
            margin-bottom: 16px;
            animation: slideIn 0.3s ease-out;
        }

        .call-transcript-speaker {
            font-size: 12px;
            font-weight: 600;
            color: #605e5c;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .call-transcript-text {
            font-size: 14px;
            color: #323130;
            line-height: 1.5;
        }

        .call-controls {
            padding: 30px 20px;
            display: flex;
            justify-content: center;
            gap: 16px;
            background: rgba(0, 0, 0, 0.1);
        }

        .call-control-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.2s;
            position: relative;
        }

        .call-control-btn svg {
            width: 26px;
            height: 26px;
            fill: white;
            display: block;
        }

        .call-control-btn .icon-off {
            display: none;
        }

        .call-control-btn.is-muted .icon-on {
            display: none;
        }

        .call-control-btn.is-muted .icon-off {
            display: block;
        }

        .call-control-btn.mute {
            background: rgba(255, 255, 255, 0.2);
        }

        .call-control-btn.mute:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .call-control-btn.mute.muted {
            background: rgba(239, 68, 68, 0.8);
        }

        .call-control-btn.speaker {
            background: rgba(255, 255, 255, 0.2);
        }

        .call-control-btn.speaker:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .call-control-btn.speaker.muted {
            background: rgba(239, 68, 68, 0.8);
        }

        .call-control-btn.end {
            background: #d13438;
        }

        .call-control-btn.end:hover {
            background: #a80000;
        }

        .speaking-indicator {
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 3px;
            background: white;
            border-radius: 2px;
            animation: speakingPulse 0.8s ease-in-out infinite;
            display: none;
        }

        .speaking-indicator.active {
            display: block;
        }

        @keyframes speakingPulse {
            0%, 100% { opacity: 0.3; transform: translateX(-50%) scaleX(0.8); }
            50% { opacity: 1; transform: translateX(-50%) scaleX(1); }
        }

        .pulse-ring {
            width: 120px;
            height: 120px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            position: absolute;
            animation: pulseRing 2s infinite;
        }

        @keyframes pulseRing {
            0% {
                transform: scale(0.9);
                opacity: 1;
            }
            100% {
                transform: scale(1.4);
                opacity: 0;
            }
        }

        /* Disconnect Options */
        .disconnect-options {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 6.4px 14.4px rgba(0, 0, 0, 0.13);
            text-align: center;
            display: none;
        }

        .disconnect-options.active {
            display: block;
        }

        .disconnect-options h3 {
            color: #323130;
            font-size: 18px;
            margin-bottom: 12px;
        }

        .disconnect-options p {
            color: #605e5c;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .disconnect-btn {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #0078d4;
            background: #0078d4;
            color: white;
            border-radius: 2px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Segoe UI', sans-serif;
            transition: all 0.2s;
        }

        .disconnect-btn:hover {
            background: #106ebe;
        }

        .disconnect-btn.secondary {
            background: white;
            color: #323130;
            border-color: #8a8886;
        }

        .disconnect-btn.secondary:hover {
            background: #f3f2f1;
        }

        /* Callback Form Styles */
        .callback-form {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #323130;
            margin-bottom: 4px;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #8a8886;
            border-radius: 2px;
            font-size: 14px;
            font-family: 'Segoe UI', sans-serif;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            border-color: #0078d4;
            border-width: 2px;
            padding: 7px 11px;
        }

        .form-submit {
            width: 100%;
            padding: 10px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Segoe UI', sans-serif;
            transition: background 0.2s;
        }

        .form-submit:hover {
            background: #106ebe;
        }

        .form-submit.callback-submit {
            border-radius: 4px;
            box-shadow: 0 4px 0 #0b4f8a, 0 8px 16px rgba(15, 108, 189, 0.2);
            transition: background 0.2s, transform 0.15s, box-shadow 0.15s;
        }

        .form-submit.callback-submit:hover {
            background: #0d4f99;
            transform: translateY(-1px);
            box-shadow: 0 5px 0 #0b4f8a, 0 10px 18px rgba(15, 108, 189, 0.24);
        }

        .form-submit.callback-submit:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #0b4f8a, 0 4px 10px rgba(15, 108, 189, 0.2);
        }

        .callback-cancel {
            width: 70%;
            margin: 8px auto 0;
            display: block;
            border-radius: 4px;
            box-shadow: 0 3px 0 #d2d0ce, 0 6px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.15s, box-shadow 0.15s, background 0.2s, border-color 0.2s;
        }

        .callback-cancel:hover {
            background: #f8f7f6;
            border-color: #605e5c;
            transform: translateY(-1px);
            box-shadow: 0 4px 0 #d2d0ce, 0 8px 14px rgba(0, 0, 0, 0.1);
        }

        .callback-cancel:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 #d2d0ce, 0 3px 8px rgba(0, 0, 0, 0.08);
        }

        .confirmation-message {
            text-align: center;
            padding: 20px;
        }

        .confirmation-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .confirmation-title {
            font-size: 18px;
            font-weight: 600;
            color: #323130;
            margin-bottom: 8px;
        }

        .confirmation-text {
            font-size: 14px;
            color: #605e5c;
            line-height: 1.5;
        }

        /* Voice Assistant Styles */
        .voice-interface {
            display: none;
            flex-direction: column;
            position: absolute;
            top: 66px;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 10;
        }

        .voice-interface.active {
            display: flex;
        }

        .voice-transcript {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: white;
        }

        .transcript-entry {
            margin-bottom: 16px;
            animation: slideIn 0.3s ease-out;
        }

        .transcript-speaker {
            font-size: 12px;
            font-weight: 600;
            color: #605e5c;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .transcript-text {
            font-size: 14px;
            color: #323130;
            line-height: 1.5;
        }

        .voice-controls {
            padding: 16px 20px;
            background: white;
            border-top: 1px solid #edebe9;
            display: flex;
            justify-content: center;
            gap: 12px;
        }

        .voice-control-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
        }

        .voice-control-btn.mute-voice {
            background: #f3f2f1;
            color: #323130;
        }

        .voice-control-btn.mute-voice:hover {
            background: #e1dfdd;
        }

        .voice-control-btn.mute-voice.muted {
            background: #d13438;
            color: white;
        }

        .voice-control-btn.end-voice {
            background: #d13438;
            color: white;
        }

        .voice-control-btn.end-voice:hover {
            background: #a80000;
        }

        .voice-control-btn.chat-toggle {
            background: #0078d4;
            color: white;
        }

        .voice-control-btn.chat-toggle:hover {
            background: #106ebe;
        }

        .voice-footer {
            padding: 8px 20px;
            background: #faf9f8;
            border-top: 1px solid #edebe9;
            font-size: 11px;
            color: #605e5c;
            text-align: center;
        }

        /* Business Hours Notice */
        .hours-notice {
            background: #f7f6f3;
            border: 1px solid #e1dfdd;
            border-left: 4px solid #107c10;
            border-radius: 6px;
            padding: 12px 14px;
            margin: 12px 20px;
            font-size: 12px;
            color: #1b1a19;
            line-height: 1.6;
        }

        .hours-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: #0b5a0b;
        }

        /* In-Chat Option Cards */
        .chat-option-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 18px 20px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: flex-start;
            gap: 14px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        }

        .chat-option-card:hover {
            border-color: #c9def5;
            background: #f7fbff;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(15, 108, 189, 0.12);
        }

        .chat-option-card:active {
            transform: translateY(0);
        }

        .chat-option-icon {
            font-size: 26px;
            flex-shrink: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f6ff;
            border-radius: 10px;
        }

        .chat-option-icon svg {
            width: 20px;
            height: 20px;
            fill: #0f6cbd;
            display: block;
        }

        .chat-option-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            filter: grayscale(1) sepia(1) hue-rotate(200deg) saturate(3) brightness(0.65) contrast(1.1);
        }

        .chat-option-content {
            flex: 1;
        }

        .chat-option-title {
            font-size: 15px;
            font-weight: 600;
            color: #1b1b1b;
            margin-bottom: 6px;
        }

        .chat-option-description {
            font-size: 13px;
            color: #5c6f82;
            line-height: 1.5;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }

        /* Quote Summary Card */
        .quote-card {
            margin-top: 14px;
            padding: 16px 18px;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 50%, #f0fdfa 100%);
            border-radius: 10px;
            border-left: 4px solid #16a34a;
            box-shadow: 0 2px 8px rgba(22, 163, 106, 0.1);
            animation: quoteSlideIn 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }

        .quote-card::before {
            content: '';
            position: absolute;
            top: -20px;
            right: -20px;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, rgba(22, 163, 106, 0.08) 0%, transparent 70%);
            border-radius: 50%;
        }

        .quote-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .quote-card-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            background: #16a34a;
            color: white;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.3px;
        }

        .quote-card-ref {
            font-size: 11px;
            color: #6b7280;
            font-family: 'Courier New', monospace;
        }

        .quote-card-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px 16px;
            margin: 10px 0;
        }

        .quote-card-item {
            font-size: 13px;
            color: #374151;
            line-height: 1.4;
        }

        .quote-card-item strong {
            color: #111827;
            font-weight: 600;
        }

        .quote-card-total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #bbf7d0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quote-card-total-label {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
        }

        .quote-card-total-value {
            font-size: 20px;
            font-weight: 700;
            color: #16a34a;
        }

        .quote-card-footer {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid #d1fae5;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .quote-card-email {
            font-size: 12px;
            color: #059669;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .quote-card-validity {
            font-size: 11px;
            color: #6b7280;
        }

        .quote-sent-pulse {
            animation: quoteSentPulse 2s ease-in-out;
        }

        /* Conversation Summary Card */
        .summary-card {
            margin-top: 14px;
            padding: 16px 18px;
            background: linear-gradient(135deg, #eff6ff 0%, #eef2ff 50%, #f0f9ff 100%);
            border-radius: 10px;
            border-left: 4px solid #0f6cbd;
            box-shadow: 0 2px 8px rgba(15, 108, 189, 0.1);
            animation: quoteSlideIn 0.5s ease-out;
        }

        .summary-card-header {
            font-size: 14px;
            font-weight: 600;
            color: #0f6cbd;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .summary-card-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .summary-card-list li {
            font-size: 13px;
            color: #374151;
            padding: 4px 0;
            display: flex;
            align-items: flex-start;
            gap: 6px;
            line-height: 1.5;
        }

        .summary-card-list li::before {
            content: '•';
            color: #0f6cbd;
            font-weight: 700;
            flex-shrink: 0;
        }

        .summary-card-footer {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid #bfdbfe;
            font-size: 12px;
            color: #6b7280;
            font-style: italic;
        }

        @keyframes quoteSlideIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes quoteSentPulse {
            0% { box-shadow: 0 0 0 0 rgba(22, 163, 106, 0.3); }
            50% { box-shadow: 0 0 0 8px rgba(22, 163, 106, 0); }
            100% { box-shadow: 0 2px 8px rgba(22, 163, 106, 0.1); }
        }
    </style>
</head>
<body>
    <!-- M365 Page Layout -->
    <div class="m365-page">
        <!-- Top Navigation -->
        <nav class="top-nav">
            <div class="nav-content">
                <div class="nav-left">
                    <a href="#" class="microsoft-logo">
                        <img src="Microsoft Logo.jpg" alt="Microsoft" />
                    </a>
                    <ul class="nav-links">
                        <li class="nav-item">
                            <a href="#" onclick="toggleProductsDropdown(event)">Products <span class="nav-dropdown">∨</span></a>
                            <div class="dropdown-menu" id="productsDropdown">
                                <div class="dropdown-column">
                                    <h3>For individuals</h3>
                                    <a href="#">Pricing for individuals</a>
                                    <a href="#">For families</a>
                                    <a href="#">For single users</a>
                                    <a href="#">For premium users</a>
                                    <a href="#">For students</a>
                                    <a href="#">Learn more</a>
                                </div>
                                <div class="dropdown-column">
                                    <h3>For business</h3>
                                    <a href="#">Pricing for business</a>
                                    <a href="#">For small business</a>
                                    <a href="#">For schools</a>
                                    <a href="#">For enterprise</a>
                                    <a href="#">For nonprofits</a>
                                </div>
                                <div class="dropdown-column">
                                    <h3>For enterprise</h3>
                                    <a href="#">Pricing for enterprise</a>
                                    <a href="#">For fortnight workers</a>
                                    <a href="#">For nonprofits</a>
                                </div>
                                <div class="dropdown-column">
                                    <h3>Microsoft 365 Copilot</h3>
                                    <a href="#">Meet Copilot</a>
                                    <a href="#">Copilot Chat</a>
                                    <a href="#">AI Agents</a>
                                    <a href="#">Daily Prompt Guide</a>
                                    <a href="#">Plans and pricing</a>
                                </div>
                                <div class="dropdown-column">
                                    <h3>Apps and services</h3>
                                    <a href="#">Microsoft Teams</a>
                                    <a href="#">Word</a>
                                    <a href="#">Excel</a>
                                    <a href="#">PowerPoint</a>
                                    <a href="#">Outlook</a>
                                    <a href="#">OneDrive</a>
                                    <a href="#">SharePoint</a>
                                    <a href="#">Planner</a>
                                    <a href="#">See all apps and services</a>
                                </div>
                                <div class="dropdown-column">
                                    <h3>Related products</h3>
                                    <a href="#">Microsoft Office</a>
                                    <a href="#">Windows 365</a>
                                    <a href="#">Microsoft Viva</a>
                                    <a href="#">Microsoft Edge</a>
                                    <a href="#">Microsoft Agent 365</a>
                                </div>
                            </div>
                        </li>
                        <li><a href="#">Plans and pricing</a></li>
                        <li><a href="#">Resources <span class="nav-dropdown">∨</span></a></li>
                        <li><a href="#">Support <span class="nav-dropdown">∨</span></a></li>
                    </ul>
                </div>
                <div class="nav-right">
                    <button class="nav-btn search-btn">Search 🔍</button>
                    <button class="nav-btn">Contact Sales</button>
                    <button class="nav-btn primary">Try for free</button>
                    <button class="nav-btn secondary">Admin center</button>
                    <button class="nav-btn user-btn">Sunil 👤</button>
                </div>
            </div>
        </nav>

        <!-- Promotion Banner -->
        <div class="promo-banner" id="promoBanner">
            <div class="promo-content">
                <span class="promo-text">Adopt AI securely with Microsoft 365 Copilot Business. Save up to 35% with a qualifying subscription. <a href="#" class="promo-link">See options</a></span>
            </div>
            <button class="promo-close" onclick="closeBanner()" title="Close">×</button>
        </div>

        <!-- Prototype Context Panel -->
        <div class="prototype-context-panel" id="prototypeContextPanel">
            <div class="context-header-row">
                <div class="context-header">Prototype Scenario</div>
                <div class="context-actions">
                    <button class="context-refresh" title="Refresh" onclick="refreshPrototype()" aria-label="Refresh">↻</button>
                </div>
            </div>
            <h3 class="context-title" id="contextTitle">Immediate Assist</h3>
            <p class="context-description" id="contextDescription">When a customer requests human support outside business hours, AI voice assistance is offered first for immediate help. A callback remains available at any time.</p>
            <div class="context-divider"></div>
            <div class="variant-switcher">
                <button class="variant-btn" id="variantHybrid" onclick="switchPrototypeVariant('hybrid')">Customer Choice</button>
                <button class="variant-btn" id="variantAiFirst" onclick="switchPrototypeVariant('ai_first')">Immediate Assist</button>
                <button class="variant-btn" id="variantHumanFirst" onclick="switchPrototypeVariant('human_first')">Assisted Follow-Up</button>
            </div>
            <div style="margin-top: 16px;">
                <button onclick="copyPrototypeLink()" class="context-link" title="Share this prototype" style="display: inline-block; padding: 8px 16px; background: #0078d4; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background 0.2s; font-family: inherit;">📤 Share this Prototype</button>
            </div>
        </div>

        <!-- Page Content -->
        <div class="page-content">
            <div class="hero-section">
                <div class="hero-text">
                    <div class="discount-badge">Discount offer</div>
                    <h1 class="hero-title">Adopt AI confidently and securely</h1>
                    <p class="hero-description">For a limited time, save up to 16% when you buy Microsoft 365 Copilot Business with a qualifying subscription.</p>
                    <div class="hero-buttons">
                        <button class="hero-cta primary">Compare plans and pricing</button>
                        <button class="hero-cta secondary">Help me choose</button>
                    </div>
                </div>
                <div class="hero-image">
                    💼
                </div>
            </div>

            <div>
                <h2 class="section-title">Do more of what you love with Microsoft 365</h2>
                <p class="section-description">Discover how businesses of all sizes and industries use Microsoft 365 to stay productive, connected, and secure. See how the right tools make work easier, wherever you are.</p>
                
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-icon">🏢</div>
                        <div class="card-title">Real estate agent</div>
                    </div>
                    <div class="card">
                        <div class="card-icon">🏋️</div>
                        <div class="card-title">Fitness instructor</div>
                    </div>
                    <div class="card">
                        <div class="card-icon">🐕</div>
                        <div class="card-title">Veterinarian</div>
                    </div>
                    <div class="card">
                        <div class="card-icon">☕</div>
                        <div class="card-title">Cafe owner</div>
                    </div>
                    <div class="card">
                        <div class="card-icon">🎨</div>
                        <div class="card-title">Freelance designer</div>
                    </div>
                    <div class="card">
                        <div class="card-icon">🚚</div>
                        <div class="card-title">Food truck owner</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat FAB Button (when closed) -->
    <button class="chat-fab hidden" id="chatFab" onclick="openChat()">
        <div class="chat-fab-icon">💬</div>
        <div class="chat-fab-text">Ask Microsoft</div>
        <div class="chat-fab-button">+</div>
    </button>

    <!-- Chat Container -->
    <div class="chat-container">
        <div class="chat-header" id="chatHeader">
            <div class="header-left">
                <div class="agent-avatar" id="agentAvatar">
                    <img src="Icon.jpg" alt="Ask Microsoft" />
                </div>
                <div class="agent-info">
                    <div class="agent-name" id="agentName">Ask Microsoft</div>
                </div>
            </div>
            <div style="display: flex; gap: 4px;">
                <button class="minimize-btn" onclick="minimizeChat()" title="Minimize">−</button>
                <button class="close-btn" onclick="closeChat()" title="Close">✕</button>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div class="message-bubble">
                    Hi. I'm an AI agent, I can help you compare plans and features, start a free trial, answer support questions or connect you with a Microsoft Sales Representative. You can also request a sales call <a href="https://www.microsoft.com/en-us/microsoft-365/microsoft-365-business" target="_blank" rel="noopener noreferrer">here</a> or call us at (800) 642-7676 M-F 6 AM to 6 PM PT. What can I do for you?
                    <br><br>
                    To learn more about this AI web feature, read the <a href="https://aka.ms/AITransparencyFAQ" target="_blank" rel="noopener noreferrer">Transparency FAQ (PDF)</a>.
                    <div class="message-time">just now</div>
                    <div class="feedback-buttons">
                        <button class="feedback-btn" onclick="giveFeedback('helpful')" title="Helpful">👍</button>
                        <button class="feedback-btn" onclick="giveFeedback('not-helpful')" title="Not helpful">👎</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="handoff-banner" id="handoffBanner">
            Connecting you with a human agent...
        </div>

        <div class="quick-actions" id="quickActions">
            <button class="quick-action-btn" onclick="sendQuickMessage('I need help with my account')">Account Help</button>
            <button class="quick-action-btn" onclick="sendQuickMessage('How do I reset my password?')">Password Reset</button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Talk to a human agent')">Human Agent</button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Talk to a human')">Test Off-hours Flow</button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Chat with human')">Chat with Human</button>
            <button class="quick-action-btn" onclick="sendQuickMessage('I have a billing question')">Billing</button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Technical support needed')">Tech Support</button>
        </div>

        <div class="disclaimer">
            AI-generated content may be incorrect
        </div>

        <div class="chat-input-area">
            <textarea 
                class="chat-input" 
                id="messageInput" 
                placeholder="Ask a work question or make a request..."
                onkeypress="handleKeyPress(event)"
                rows="1"
            ></textarea>
            <button class="send-button" id="sendButton" onclick="sendMessage()">➤</button>
        </div>

        <!-- Voice Interface (hidden by default) -->
        <div class="voice-interface" id="voiceInterface">
            <div class="voice-transcript" id="voiceTranscript">
                <!-- Transcript entries will be added here -->
            </div>
            <div class="voice-controls">
                <button class="voice-control-btn mute-voice" id="voiceMuteBtn" onclick="toggleVoiceMute()" title="Mute">
                    🎤
                </button>
                <button class="voice-control-btn end-voice" onclick="endVoiceSession()" title="End Session">
                    ✖
                </button>
                <button class="voice-control-btn chat-toggle" onclick="toggleBackToChat()" title="Switch to Chat">
                    💬
                </button>
            </div>
            <div class="voice-footer">
                Real-time AI voice conversation • Transcript displayed above
            </div>
        </div>
    </div>

    <!-- Choice Modal -->
    <div class="modal-overlay" id="choiceModal">
        <div class="choice-modal">
            <div class="modal-header">
                <div class="modal-icon">🤝</div>
                <div class="modal-title">Connect with a Human Agent</div>
                <div class="modal-subtitle">How would you like to connect?</div>
            </div>
            <div class="choice-options">
                <div class="choice-card" onclick="selectConnectionType('chat')">
                    <div class="choice-card-icon">💬</div>
                    <div class="choice-card-content">
                        <div class="choice-card-title">Live Chat</div>
                        <div class="choice-card-description">Continue chatting with a human agent in this window. Response time: ~30 seconds</div>
                    </div>
                </div>
                <div class="choice-card" onclick="selectConnectionType('call')">
                    <div class="choice-card-icon">📞</div>
                    <div class="choice-card-content">
                        <div class="choice-card-title">Live Call</div>
                        <div class="choice-card-description">Connect with an agent via voice call. Average wait time: ~1 minute</div>
                    </div>
                </div>
            </div>
            <button class="modal-cancel" onclick="closeChoiceModal()">Cancel</button>
        </div>
    </div>

    <!-- Sales Assistant Options Modal -->
    <div class="modal-overlay" id="salesOptionsModal">
        <div class="choice-modal">
            <div class="modal-header">
                <div class="modal-icon">🏢</div>
                <div class="modal-title">Connect with Sales Support</div>
                <div class="modal-subtitle">We're currently outside business hours (M-F, 6 AM-6 PM PT)</div>
            </div>
            <div class="choice-options">
                <div class="choice-card" onclick="selectSalesOption('callback')">
                    <div class="choice-card-icon">📅</div>
                    <div class="choice-card-content">
                        <div class="choice-card-title">Request a Callback</div>
                        <div class="choice-card-description">A Microsoft sales associate will contact you within 48 hours.</div>
                    </div>
                </div>
                <div class="choice-card" onclick="selectSalesOption('ai-assistant')">
                    <div class="choice-card-icon">🤖</div>
                    <div class="choice-card-content">
                        <div class="choice-card-title">Ask Microsoft Voice Agent</div>
                        <div class="choice-card-description">Available immediately. Can answer most product and plan questions.</div>
                    </div>
                </div>
            </div>
            <button class="modal-cancel" onclick="closeSalesOptionsModal()">Cancel</button>
        </div>
    </div>

    <!-- Callback Form Modal -->
    <div class="modal-overlay" id="callbackFormModal">
        <div class="choice-modal">
            <div class="modal-header">
                <div class="modal-icon">📞</div>
                <div class="modal-title">Request a Callback</div>
                <div class="modal-subtitle">We'll get back to you within 48 hours</div>
            </div>
            <form class="callback-form" id="callbackForm" onsubmit="submitCallbackForm(event)">
                <div class="form-group">
                    <label class="form-label" for="callbackName">Name *</label>
                    <input type="text" class="form-input" id="callbackName" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="callbackBusiness">Business Name *</label>
                    <input type="text" class="form-input" id="callbackBusiness" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="callbackEmail">Email *</label>
                    <input type="email" class="form-input" id="callbackEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="callbackPhone">Phone Number *</label>
                    <input type="tel" class="form-input" id="callbackPhone" pattern="[0-9\-\+\(\)\s]+" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="callbackUsers">Estimated Number of Users *</label>
                    <input type="number" class="form-input" id="callbackUsers" min="1" required>
                </div>
                <button type="submit" class="form-submit callback-submit">Submit Request</button>
            </form>
            <button class="modal-cancel callback-cancel" onclick="closeCallbackFormModal()">Cancel</button>
        </div>
    </div>

    <!-- Callback Submitted Modal -->
    <div class="modal-overlay" id="callbackConfirmationModal">
        <div class="choice-modal">
            <div class="confirmation-message">
                <div class="confirmation-icon">✅</div>
                <div class="confirmation-title">Request Submitted Successfully</div>
                <div class="confirmation-text">
                    Thank you. A Microsoft sales associate will contact you within 48 hours.
                </div>
            </div>
            <button class="modal-cancel" style="margin-top: 12px;" onclick="closeCallbackConfirmationAndOffer()">OK</button>
        </div>
    </div>

    <!-- Speak While You Wait Modal -->
    <div class="modal-overlay" id="speakWhileYouWaitModal">
        <div class="choice-modal">
            <div class="modal-header">
                <div class="modal-icon">⏱️</div>
                <div class="modal-title">Get Answers While You Wait</div>
                <div class="modal-subtitle">Speak with our Ask Microsoft Voice Agent in the meantime</div>
            </div>
            <p style="margin: 20px 0; color: #666; font-size: 14px; line-height: 1.6;">
                Your callback request is confirmed. While you wait for a human agent, you can speak with our Ask Microsoft Voice Agent to learn more about Microsoft 365.
            </p>
            <button class="form-submit" onclick="startVoiceSessionFromCallback()">Speak with Ask Microsoft Voice Agent</button>
            <button class="modal-cancel" style="margin-top: 12px;" onclick="closeSpeakWhileYouWaitModal()">Skip, Just Wait</button>
        </div>
    </div>

    <!-- Call Screen -->
    <div class="call-screen" id="callScreen">
        <div class="call-screen-header">
            <h3>Microsoft 365 Sales</h3>
        </div>
        <div class="call-screen-content">
            <div class="pulse-ring" id="pulseRing" style="display: none;"></div>
            <div class="call-avatar" id="callAvatar"><img src="voice.png" alt="Ask Microsoft Voice Agent" /></div>
            <div class="call-info">
                <div class="call-agent-name" id="callAgentName">Connecting...</div>
                <div class="call-status connecting" id="callStatus">Connecting you to Ask Microsoft Voice Agent...</div>
                <div class="call-timer" id="callTimer" style="display: none;">00:00</div>
            </div>
            <div class="call-transcript-area" id="callTranscriptArea">
                <!-- Transcript entries will be added here -->
            </div>
            <div class="disconnect-options" id="disconnectOptions">
                <h3>Call Ended</h3>
                <p>Would you like to request a callback from a human sales associate?</p>
                <button class="disconnect-btn" onclick="requestCallbackAfterCall()">Yes, Request Callback</button>
                <button class="disconnect-btn secondary" onclick="closeCallScreen()">No, Return to Chat</button>
            </div>
        </div>
        <div class="call-controls">
            <button class="call-control-btn mute" id="muteBtnCall" onclick="toggleMuteCall()" title="Mute Microphone" aria-label="Mute Microphone">
                <svg class="icon-on" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 1 1-10 0H5a7 7 0 0 0 6 6.92V21h2v-3.08A7 7 0 0 0 19 11z"/>
                </svg>
                <svg class="icon-off" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M4.27 3 3 4.27l6 6V11a3 3 0 0 0 4.11 2.78l1.5 1.5A5 5 0 0 1 7 11H5a7 7 0 0 0 6 6.92V21h2v-3.08a7 7 0 0 0 3.31-.9l2.42 2.42 1.27-1.27L4.27 3zM12 2a3 3 0 0 0-3 3v.18l6 6V5a3 3 0 0 0-3-3z"/>
                </svg>
            </button>
            <button class="call-control-btn speaker" id="speakerBtn" onclick="toggleSpeaker()" title="Mute Speaker" aria-label="Mute Speaker">
                <svg class="icon-on" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M3 10v4h4l5 4V6L7 10H3zm13.5 2a4.5 4.5 0 0 0-2.5-4.03v8.06A4.5 4.5 0 0 0 16.5 12zm2.5 0a7 7 0 0 1-4 6.32v-1.9a5.5 5.5 0 0 0 0-8.84v-1.9A7 7 0 0 1 19 12z"/>
                </svg>
                <svg class="icon-off" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M3 10v4h4l5 4V6L7 10H3zm13.5 2a4.5 4.5 0 0 0-2.5-4.03v2.2l2.3 2.3c.13-.15.2-.33.2-.47zm2.5 0a7 7 0 0 1-2.02 4.9l-1.43-1.43A5.5 5.5 0 0 0 15 12c0-.54-.08-1.05-.24-1.54l-1.52-1.52A7 7 0 0 1 19 12zM4.27 3 3 4.27l17.73 17.73L22 20.73 4.27 3z"/>
                </svg>
                <div class="speaking-indicator" id="speakingIndicator"></div>
            </button>
            <button class="call-control-btn end" onclick="endAICall()" title="Disconnect" aria-label="Disconnect">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M19 7.27 16.73 5 12 9.73 7.27 5 5 7.27 9.73 12 5 16.73 7.27 19 12 14.27 16.73 19 19 16.73 14.27 12z"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // PRODUCTION NOTE: In a real implementation, this would integrate with:
        // - Microsoft Graph API for Microsoft 365 data
        // - Web scraping service or API to fetch live content from microsoft.com
        // - Content management system with regularly updated Microsoft 365 information
        // This prototype simulates those capabilities with pre-loaded knowledge base
        
        let isHumanAgent = false;
        let conversation = [];
        let isMuted = false;
        let callTimer = null;
        let callDuration = 0;
        let isVoiceMode = false;
        let voiceMuted = false;
        let speechSynthesis = window.speechSynthesis;
        let isSpeaking = false;
        let audioEnabled = true;
        let voiceSessionGeneration = 0;
        let speechKeepAliveTimer = null;  // Chrome 15-second TTS bug workaround

        // ── Chrome/Edge speechSynthesis keepalive ──────────────────────────
        // Chrome silently kills any utterance longer than ~15 s.
        // Workaround: pause() + resume() every 10 s while speaking.
        function startSpeechKeepAlive() {
            stopSpeechKeepAlive();
            speechKeepAliveTimer = setInterval(() => {
                if (speechSynthesis.speaking && !speechSynthesis.paused) {
                    speechSynthesis.pause();
                    speechSynthesis.resume();
                }
            }, 10000);
        }
        function stopSpeechKeepAlive() {
            if (speechKeepAliveTimer) { clearInterval(speechKeepAliveTimer); speechKeepAliveTimer = null; }
        }

        let callbackRequested = false;
        let callbackRequestedAfterVoiceCall = false;
        let offHoursAiFirstFlow = false;
        let callbackFlowContext = null;
        let voiceSessionContext = { fromCallback: false, fromOffHoursAiFirst: false };
        let conversationContext = {
            numEmployees: null,
            workLocation: null,
            securityNeeds: null,
            timeline: null,
            interestedPlans: [],
            pricePerUser: null,
            monthlyTotal: null,
            quoteGenerated: false,
            quoteId: null,
            quoteSentToEmail: false,
            quoteReadyForSend: false
        };

        // Simulated Microsoft 365 knowledge base (in production, this would query the actual website)
        const microsoft365Info = {
            plans: "📄 Source: microsoft.com/microsoft-365\n\nMicrosoft 365 offers several plans for businesses:\n\n• Microsoft 365 Business Basic - $6/user/month\n  Web and mobile versions of Office apps, Exchange email hosting with 50GB mailbox, 1TB OneDrive cloud storage, Microsoft Teams\n\n• Microsoft 365 Business Standard - $12.50/user/month\n  Desktop Office apps (Word, Excel, PowerPoint, Outlook), all Business Basic features, webinar capabilities, customer appointment booking\n\n• Microsoft 365 Business Premium - $22/user/month\n  Advanced cybersecurity, device management, all Business Standard features, Microsoft Defender for Business, Azure Information Protection\n\nAll plans include Microsoft Teams, OneDrive, Exchange, SharePoint, and can scale up to 300 users.",
            
            copilot: "📄 Source: microsoft.com/microsoft-365\n\nMicrosoft 365 Copilot is an AI-powered productivity assistant:\n\n• Available in Word, Excel, PowerPoint, Outlook, Teams, and more\n• Helps draft documents, analyze data, create presentations, summarize meetings\n• Pricing: $30/user/month as an add-on\n• Requirements: Microsoft 365 Business Standard, Business Premium, or Enterprise plan\n• Uses your business data with enterprise-grade security and privacy\n\nLimited-time offer: Save up to 16% when bundled with qualifying Microsoft 365 subscriptions.",
            
            apps: "📄 Source: microsoft.com/microsoft-365\n\nMicrosoft 365 includes premium productivity applications:\n\n• Word - Document creation, editing, and collaboration\n• Excel - Spreadsheets, data analysis, and PivotTables\n• PowerPoint - Professional presentations and slide decks\n• Outlook - Email, calendar, and contact management\n• Teams - Chat, video meetings, file sharing, and collaboration\n• OneDrive - 1TB of cloud storage per user with file sync\n• SharePoint - Intranet, team sites, and content management\n• OneNote - Digital notebook for note-taking\n• Access & Publisher (PC only) - Database and desktop publishing\n\nWeb, desktop, and mobile versions available depending on your plan.",
            
            security: "📄 Source: microsoft.com/microsoft-365\n\nMicrosoft 365 Business Premium provides enterprise-grade security:\n\n• Microsoft Defender for Business - Advanced threat protection against malware, ransomware, and phishing\n• Data Loss Prevention (DLP) - Prevent sensitive data from being shared\n• Multi-factor authentication (MFA) - Extra layer of identity verification\n• Mobile device management (MDM) - Secure and manage employee devices\n• Azure Information Protection - Classify and protect sensitive documents\n• Attack simulation training - Test and train employees on security threats\n• Conditional access policies - Control access based on user, location, and device\n\nBusiness Basic and Standard include baseline security features. Premium includes comprehensive protection.",
            
            support: "📄 Source: microsoft.com/microsoft-365\n\nMicrosoft 365 support and resources:\n\n• 24/7 web and phone support for critical issues\n• Online help center with articles, videos, and tutorials\n• Microsoft 365 admin center for IT management\n• Community forums with expert answers\n• FastTrack deployment assistance (for eligible plans)\n• Microsoft Learn training and certification paths\n\nContact Sales: (800) 642-7676 (M-F, 6 AM-6 PM PT)\nSupport is included with all Microsoft 365 subscriptions.",
            
            features: "📄 Source: microsoft.com/microsoft-365\n\nKey Microsoft 365 Business features:\n\n• Cloud storage: 1TB OneDrive per user\n• Email hosting: Exchange with 50GB mailbox\n• Collaboration: Microsoft Teams for chat and meetings\n• Mobile apps: Full-featured apps for iOS and Android\n• File sharing: Secure internal and external sharing\n• Video conferencing: Teams meetings for up to 300 participants\n• Business email: Custom domain email addresses\n• Office on the web: Browser-based versions of Office apps\n• Automatic updates: Always have the latest features and security\n\nBusiness Premium adds advanced security, device management, and compliance tools.",
            
            comparison: "📄 Source: microsoft.com/microsoft-365\n\nMicrosoft 365 Business Plans Comparison:\n\nBasic ($6/user/mo) - Best for businesses needing email, cloud storage, and web apps\n✓ Email hosting ✓ 1TB storage ✓ Web/mobile Office apps ✓ Teams\n✗ Desktop Office apps ✗ Advanced security\n\nStandard ($12.50/user/mo) - Best for businesses needing full productivity suite\n✓ Everything in Basic ✓ Desktop Office apps ✓ Webinars ✓ Customer booking\n✗ Advanced security and device management\n\nPremium ($22/user/mo) - Best for businesses needing security & compliance\n✓ Everything in Standard ✓ Advanced security ✓ Device management ✓ Threat protection\n✓ Information protection ✓ Azure Active Directory Premium",
            
            migration: "📄 Source: microsoft.com/microsoft-365\n\nMigrating to Microsoft 365:\n\n• FastTrack assistance available for 150+ seats (at no additional cost)\n• Migration tools for email, files, and data from Google Workspace, on-premises servers\n• Step-by-step guides and migration resources\n• Partner assistance available through Microsoft Partner Network\n• Typical migration timeline: 1-4 weeks depending on size\n• Data migration includes email, contacts, calendars, and files\n• No downtime required for most migration scenarios\n\nMicrosoft support team can help plan and execute your migration.",
            
            trial: "📄 Source: microsoft.com/microsoft-365\n\nMicrosoft 365 Free Trial:\n\n• 30-day free trial available for Business Standard and Business Premium\n• No credit card required to start trial\n• Full access to all plan features during trial\n• Up to 25 users can be added to trial\n• Trial includes technical support\n• Easy to purchase and continue after trial ends\n• Your data and settings are preserved if you purchase\n\nStart your free trial at microsoft.com/microsoft-365/business"
        };

        const botResponses = {
            'account': 'I can help you with account-related issues. What specific account question do you have?',
            'password': 'To reset your password:\n1. Visit the Microsoft 365 sign-in page\n2. Click "Forgot my password"\n3. Follow the reset instructions\n\nWould you like me to connect you with an agent for further assistance?',
            'billing': 'I can help with billing inquiries. Common topics include:\n• Subscription pricing\n• Payment methods\n• Invoice questions\n• Upgrade or downgrade plans\n\nWhat would you like to know about?',
            'technical': 'I\'m here to help with technical issues. Please describe the problem you\'re experiencing, including any error messages. I can also connect you with a technical support specialist if needed.',
            'human': 'I understand you\'d like to speak with a human representative. Let me help you connect!',
            'thanks': 'You\'re welcome! Is there anything else I can help you with today?',
            'bye': 'Thank you for chatting with us! Feel free to reach out anytime. Have a great day!',
            'default': 'Let me search our Microsoft 365 resources for information...'
        };

        /* Prototype Context Panel - Variant Management */
        let prototypeVariant = localStorage.getItem('prototypeVariant') || 'ai_first';

        const prototypeVariants = {
            hybrid: {
                title: 'Customer Choice',
                description: 'Customers choose between speaking with the AI voice assistant immediately or requesting a callback from a Microsoft specialist. Designed to maximize transparency and customer control.'
            },
            human_first: {
                title: 'Assisted Follow-Up',
                description: 'Customers request a callback first. After confirming the follow-up, AI voice support is offered as an optional way to get immediate answers while they wait.'
            },
            ai_first: {
                title: 'Immediate Assist',
                description: 'When a customer requests human support outside business hours, AI voice assistance is offered first for immediate help. A callback remains available at any time.'
            }
        };

        function applyVariantState(variant) {
            offHoursAiFirstFlow = variant === 'ai_first';

            document.getElementById('contextTitle').textContent = prototypeVariants[variant].title;
            document.getElementById('contextDescription').textContent = prototypeVariants[variant].description;

            document.getElementById('variantHybrid').classList.remove('active');
            document.getElementById('variantHumanFirst').classList.remove('active');
            document.getElementById('variantAiFirst').classList.remove('active');

            if (variant === 'hybrid') {
                document.getElementById('variantHybrid').classList.add('active');
            } else if (variant === 'human_first') {
                document.getElementById('variantHumanFirst').classList.add('active');
            } else if (variant === 'ai_first') {
                document.getElementById('variantAiFirst').classList.add('active');
            }
        }

        applyVariantState(prototypeVariant);

        function switchPrototypeVariant(variant) {
            if (prototypeVariant === variant) {
                return;
            }

            prototypeVariant = variant;
            localStorage.setItem('prototypeVariant', variant);
            resetChatForVariantSwitch();
            applyVariantState(variant);
        }

        function getCurrentTime() {
            return 'just now';
        }

        function refreshPrototype() {
            window.location.reload();
        }

        function copyShareLink() {
            const sharePath = window.location.href;
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(sharePath).then(() => {
                    alert('Link copied to clipboard.');
                }).catch(() => {
                    window.prompt('Copy this link:', sharePath);
                });
            } else {
                window.prompt('Copy this link:', sharePath);
            }
        }

        function copyPrototypeLink() {
            const prototypeUrl = 'https://sunilmsft.github.io/ecommerce-voice-ai-prototype/';
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(prototypeUrl).then(() => {
                    alert('Prototype link copied to clipboard. You can now paste it in Teams or email.');
                }).catch(() => {
                    window.prompt('Copy this link:', prototypeUrl);
                });
            } else {
                window.prompt('Copy this link:', prototypeUrl);
            }
        }

        function closeChat() {
            const chatContainer = document.querySelector('.chat-container');
            const chatFab = document.getElementById('chatFab');
            chatContainer.style.display = 'none';
            chatFab.classList.remove('hidden');
            chatFab.classList.add('visible');
        }

        function minimizeChat() {
            const chatContainer = document.querySelector('.chat-container');
            const chatHeader = document.getElementById('chatHeader');
            
            if (chatContainer.classList.contains('minimized')) {
                // Expand
                chatContainer.classList.remove('minimized');
                chatHeader.style.cursor = 'default';
                chatHeader.onclick = null;
            } else {
                // Minimize
                chatContainer.classList.add('minimized');
                chatHeader.style.cursor = 'pointer';
                chatHeader.onclick = function(e) {
                    // Don't expand if clicking on buttons
                    if (!e.target.closest('.minimize-btn') && !e.target.closest('.close-btn')) {
                        minimizeChat();
                    }
                };
            }
        }

        function openChat() {
            const chatContainer = document.querySelector('.chat-container');
            const chatFab = document.getElementById('chatFab');
            chatContainer.style.display = 'flex';
            chatContainer.classList.remove('minimized');
            chatFab.classList.remove('visible');
            chatFab.classList.add('hidden');
        }

        function closeBanner() {
            const banner = document.getElementById('promoBanner');
            if (banner) {
                banner.style.display = 'none';
            }
        }

        function toggleProductsDropdown(event) {
            event.preventDefault();
            const dropdown = document.getElementById('productsDropdown');
            if (dropdown) {
                dropdown.classList.toggle('active');
            }
        }

        // Close dropdown when clicking elsewhere
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('productsDropdown');
            const productsLink = event.target.closest('.nav-item a');
            if (dropdown && !productsLink) {
                dropdown.classList.remove('active');
            }
        });

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addMessage(text, type = 'bot', showFeedback = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            let feedbackHTML = '';
            if (showFeedback && type === 'bot') {
                feedbackHTML = `
                    <div class="feedback-buttons">
                        <button class="feedback-btn" onclick="giveFeedback('helpful')" title="Helpful">👍</button>
                        <button class="feedback-btn" onclick="giveFeedback('not-helpful')" title="Not helpful">👎</button>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${text.replace(/\n/g, '<br>')}
                    <div class="message-time">${getCurrentTime()}</div>
                    ${feedbackHTML}
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
            
            conversation.push({ type, text, time: getCurrentTime() });
        }

        function addSystemMessage(text, isWebSearch = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = isWebSearch ? 'message system web-search' : 'message system';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${text}
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="typing-indicator active">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function getBotResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            
            // Check for handoff requests - trigger sales assistant flow
            if (lowerMessage.includes('human') || lowerMessage.includes('agent') || 
                lowerMessage.includes('person') || lowerMessage.includes('representative') ||
                lowerMessage.includes('talk to someone') || lowerMessage.includes('speak with')) {
                return { response: 'I understand you\'d like to speak with someone. Let me help you connect!', salesHandoff: true };
            }
            
            // Check Microsoft 365 knowledge base (simulating website search)
            // Plans and pricing
            if (lowerMessage.includes('plan') || lowerMessage.includes('pricing') || lowerMessage.includes('cost') || lowerMessage.includes('price')) {
                if (lowerMessage.includes('compare') || lowerMessage.includes('comparison') || lowerMessage.includes('difference')) {
                    return { response: microsoft365Info.comparison, fromWebsite: true };
                }
                return { response: microsoft365Info.plans, fromWebsite: true };
            }
            
            // Copilot
            if (lowerMessage.includes('copilot') || (lowerMessage.includes('ai') && lowerMessage.includes('assistant'))) {
                return { response: microsoft365Info.copilot, fromWebsite: true };
            }
            
            // Applications
            if (lowerMessage.includes('app') || lowerMessage.includes('application') || lowerMessage.includes('office') || 
                lowerMessage.includes('word') || lowerMessage.includes('excel') || lowerMessage.includes('powerpoint') || 
                lowerMessage.includes('teams') || lowerMessage.includes('outlook') || lowerMessage.includes('onedrive')) {
                return { response: microsoft365Info.apps, fromWebsite: true };
            }
            
            // Security
            if (lowerMessage.includes('security') || lowerMessage.includes('secure') || lowerMessage.includes('protection') || 
                lowerMessage.includes('safe') || lowerMessage.includes('threat') || lowerMessage.includes('defender')) {
                return { response: microsoft365Info.security, fromWebsite: true };
            }
            
            // Support
            if (lowerMessage.includes('support') || lowerMessage.includes('contact') || lowerMessage.includes('phone')) {
                return { response: microsoft365Info.support, fromWebsite: true };
            }
            
            // Features
            if (lowerMessage.includes('feature') || lowerMessage.includes('what\'s included') || lowerMessage.includes('what is included') || 
                lowerMessage.includes('what do') || lowerMessage.includes('storage') || lowerMessage.includes('email')) {
                return { response: microsoft365Info.features, fromWebsite: true };
            }
            
            // Migration
            if (lowerMessage.includes('migrat') || lowerMessage.includes('switch') || lowerMessage.includes('move from') || 
                lowerMessage.includes('google workspace') || lowerMessage.includes('transfer')) {
                return { response: microsoft365Info.migration, fromWebsite: true };
            }
            
            // Trial
            if (lowerMessage.includes('trial') || lowerMessage.includes('free') || lowerMessage.includes('try')) {
                return { response: microsoft365Info.trial, fromWebsite: true };
            }
            
            // Help/Getting started
            if (lowerMessage.includes('help') || lowerMessage.includes('how to') || lowerMessage.includes('getting started') || 
                lowerMessage.includes('what is microsoft 365')) {
                return { response: 'I can help you with Microsoft 365! I have information about:\n\n• Plans and pricing\n• Features and applications\n• Security and compliance\n• Migration from other platforms\n• Free trials\n• Support options\n\nWhat would you like to know more about?', fromWebsite: true };
            }
            
            // Standard responses
            if (lowerMessage.includes('account')) return { response: botResponses.account };
            if (lowerMessage.includes('password')) return { response: botResponses.password };
            if (lowerMessage.includes('billing') || lowerMessage.includes('payment') || lowerMessage.includes('charge')) return { response: botResponses.billing };
            if (lowerMessage.includes('technical') || lowerMessage.includes('error') || lowerMessage.includes('bug') || lowerMessage.includes('broken')) return { response: botResponses.technical };
            if (lowerMessage.includes('thank') || lowerMessage.includes('thanks')) return { response: botResponses.thanks };
            if (lowerMessage.includes('bye') || lowerMessage.includes('goodbye')) return { response: botResponses.bye };
            
            // Default: search Microsoft 365 website
            return { response: botResponses.default, searchWebsite: true };
        }

        function handoffToHuman() {
            if (prototypeVariant === 'human_first') {
                showHumanFirstOffHoursOffer();
                return;
            }
            if (prototypeVariant === 'ai_first') {
                showOffHoursAiFirstOffer();
                return;
            }
            showSalesOptionsInChat();
        }

        function showSalesOptionsInChat() {
            // Add a message with business hours notice
            const optionsHTML = `
                <div class="hours-notice" style="margin: 0 0 12px 0;">
                    <div class="hours-title">Business hours notice</div>
                    <div>You've reached us outside of business hours (M-F, 6 AM to 6 PM PT). I'm still here to help — please choose one of the options below.</div>
                </div>
                <div class="options-container">
                    <div class="chat-option-card" onclick="selectSalesOption('ai-assistant')" role="button" tabindex="0">
                        <div class="chat-option-icon" style="background: white;">
                            <img src="voice.png" alt="Ask Microsoft Voice Agent" style="width: 44px; height: 44px; display: block;" />
                        </div>
                        <div class="chat-option-content">
                            <div class="chat-option-title">Speak with Ask Microsoft Voice Agent</div>
                            <div class="chat-option-description">Available immediately. Get answers to product and plan questions through an interactive voice conversation.</div>
                        </div>
                    </div>
                    <div class="chat-option-card" onclick="selectSalesOption('callback')" role="button" tabindex="0">
                        <div class="chat-option-icon">
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M6.6 10.8a12.4 12.4 0 0 0 6.6 6.6l2.2-2.2a1 1 0 0 1 1-.24c1.1.36 2.3.56 3.6.56a1 1 0 0 1 1 1v3.5a1 1 0 0 1-1 1C10.1 21 3 13.9 3 5.9a1 1 0 0 1 1-1H7.5a1 1 0 0 1 1 1c0 1.3.2 2.5.56 3.6a1 1 0 0 1-.24 1l-2.2 2.2z"/>
                            </svg>
                        </div>
                        <div class="chat-option-content">
                            <div class="chat-option-title">Request a Callback</div>
                            <div class="chat-option-description">A Microsoft sales associate will contact you within 48 hours to discuss your needs.</div>
                        </div>
                    </div>
                </div>
            `;
            
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot with-options';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    How would you like to connect with our sales team?
                    ${optionsHTML}
                    <div class="message-time">just now</div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function showHumanFirstOffHoursOffer() {
            const optionsHTML = `
                <div class="hours-notice" style="margin: 0 0 12px 0;">
                    <div class="hours-title">Business hours notice</div>
                    <div>You've reached us outside of business hours (M-F, 6 AM to 6 PM PT). I'm still here to help — please choose the option below to continue.</div>
                </div>
                <div class="options-container">
                    <div class="chat-option-card" onclick="selectSalesOption('callback')" role="button" tabindex="0" style="background: #e1efff; box-shadow: 0 10px 24px rgba(15, 108, 189, 0.24); border-color: #d6e2f3;">
                        <div class="chat-option-icon">
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M6.6 10.8a12.4 12.4 0 0 0 6.6 6.6l2.2-2.2a1 1 0 0 1 1-.24c1.1.36 2.3.56 3.6.56a1 1 0 0 1 1 1v3.5a1 1 0 0 1-1 1C10.1 21 3 13.9 3 5.9a1 1 0 0 1 1-1H7.5a1 1 0 0 1 1 1c0 1.3.2 2.5.56 3.6a1 1 0 0 1-.24 1l-2.2 2.2z"/>
                            </svg>
                        </div>
                        <div class="chat-option-content">
                            <div class="chat-option-title">Request a Callback</div>
                            <div class="chat-option-description">A Microsoft sales associate will contact you within 48 hours to discuss your needs.</div>
                        </div>
                    </div>
                </div>
            `;

            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot with-options';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    How would you like to connect with our sales team?
                    ${optionsHTML}
                    <div class="message-time">just now</div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function showChoiceModal() {
            document.getElementById('choiceModal').classList.add('active');
        }

        function closeChoiceModal() {
            document.getElementById('choiceModal').classList.remove('active');
        }

        function selectConnectionType(type) {
            closeChoiceModal();
            
            if (type === 'chat') {
                handoffToChat();
            } else if (type === 'call') {
                startCall();
            }
        }

        function handoffToChat() {
            isHumanAgent = true;
            
            // Update header
            document.getElementById('agentAvatar').textContent = '👤';
            document.getElementById('agentName').textContent = 'Microsoft Support Agent';
            
            // Show handoff banner
            document.getElementById('handoffBanner').classList.add('active');
            
            // Add system message
            addSystemMessage('🔄 Connecting you to a support agent...');
            
            // Hide quick actions
            document.getElementById('quickActions').style.display = 'none';
            
            // Simulate agent joining
            setTimeout(() => {
                addMessage('Hello! I\'m Sarah, a Microsoft support specialist. I\'ve reviewed your conversation. How can I help you today?', 'human-agent', true);
            }, 2000);
        }

        function showSalesOptionsModal() {
            document.getElementById('salesOptionsModal').classList.add('active');
        }

        function closeSalesOptionsModal() {
            document.getElementById('salesOptionsModal').classList.remove('active');
        }

        function selectSalesOption(option) {
            // Add user's choice to chat
            if (option === 'ai-assistant') {
                addMessage('I\'d like to speak with the Ask Microsoft Voice Agent now', 'user');
                setTimeout(() => {
                    addMessage('Great choice! Connecting you to our Ask Microsoft Voice Agent...', 'bot', false);
                    setTimeout(() => {
                        voiceSessionContext.fromCallback = false;
                        startVoiceSession();
                    }, 1000);
                }, 500);
            } else if (option === 'callback') {
                callbackRequestedAfterVoiceCall = false;
                addMessage('I\'d like to request a callback', 'user');
                setTimeout(() => {
                    addMessage('I\'ll help you request a callback. Please provide some information so our sales team can reach out to you.', 'bot', false);
                    setTimeout(() => {
                        showCallbackForm();
                    }, 1000);
                }, 500);
            }
        }

        function showCallbackForm() {
            document.getElementById('callbackFormModal').classList.add('active');
            const callbackTestProfiles = [
                {
                    callbackName: 'Alex Chen',
                    callbackBusiness: 'Northwind Architecture Group',
                    callbackEmail: 'alex.chen@northwind-example.com',
                    callbackPhone: '(206) 555-0198',
                    callbackUsers: '42'
                },
                {
                    callbackName: 'Marcus Thompson',
                    callbackBusiness: 'Fabrikam Health Partners',
                    callbackEmail: 'marcus.thompson@fabrikam-example.com',
                    callbackPhone: '(415) 555-0126',
                    callbackUsers: '85'
                },
                {
                    callbackName: 'Jordan Rivera',
                    callbackBusiness: 'Adventure Works Retail',
                    callbackEmail: 'jordan.rivera@adventureworks-example.com',
                    callbackPhone: '(312) 555-0174',
                    callbackUsers: '23'
                }
            ];
            const selectedProfile = callbackTestProfiles[Math.floor(Math.random() * callbackTestProfiles.length)];

            Object.entries(selectedProfile).forEach(([fieldId, fieldValue]) => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = fieldValue;
                }
            });
        }

        function closeCallbackFormModal() {
            document.getElementById('callbackFormModal').classList.remove('active');
            document.getElementById('callbackForm').reset();
        }

        function submitCallbackForm(event) {
            event.preventDefault();
            
            const name = document.getElementById('callbackName').value;
            const business = document.getElementById('callbackBusiness').value;
            const email = document.getElementById('callbackEmail').value;
            const phone = document.getElementById('callbackPhone').value;
            const users = document.getElementById('callbackUsers').value;
            
            // Log form data (in production, this would be sent to backend)
            console.log('Callback request:', { name, business, email, phone, users });
            
            // Store callback form data so the AI voice session can reference it
            conversationContext.customerName = name.split(' ')[0]; // first name
            conversationContext.customerFullName = name;
            conversationContext.businessName = business;
            conversationContext.customerEmail = email;
            conversationContext.customerPhone = phone;
            conversationContext.numEmployees = parseInt(users) || null;
            
            // Set callback state BEFORE closing form
            callbackRequested = true;
            
            closeCallbackFormModal();
            if (callbackFlowContext === 'offHoursAiFirstPostVoice') {
                callbackFlowContext = null;
                showOffHoursCallbackConfirmation();
            } else {
                showCallbackConfirmation();
                
                // Add system message to chat
                addSystemMessage('📞 Callback request submitted. A Microsoft sales associate will contact you within 48 hours.');
            }
        }

        function showCallbackConfirmation() {
            document.getElementById('callbackConfirmationModal').classList.add('active');
        }

        function closeCallbackConfirmationAndOffer() {
            document.getElementById('callbackConfirmationModal').classList.remove('active');
            if (prototypeVariant === 'hybrid' && callbackRequestedAfterVoiceCall) {
                addMessage('Your callback is confirmed. If you have questions while you wait, you can engage with the Ask Microsoft Voice Agent again by visiting this page anytime.', 'bot', false);
                callbackRequestedAfterVoiceCall = false;
                return;
            }

            // Show "speak while you wait" offer
            callbackRequestedAfterVoiceCall = false;
            document.getElementById('speakWhileYouWaitModal').classList.add('active');
        }
        function closeSpeakWhileYouWaitModal() {
            document.getElementById('speakWhileYouWaitModal').classList.remove('active');
        }

        function startVoiceSessionFromCallback() {
            closeSpeakWhileYouWaitModal();
            voiceSessionContext.fromCallback = true;
            startVoiceSession();
        }

        function startVoiceSession() {
            isVoiceMode = true;
            audioEnabled = true;
            voiceSessionGeneration++;
            
            // Load voices if not already loaded (important for Chrome)
            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.addEventListener('voiceschanged', function() {
                    console.log('Voices loaded:', speechSynthesis.getVoices().length);
                });
            }
            
            // Show call screen
            const callScreen = document.getElementById('callScreen');
            callScreen.classList.add('active');
            
            // Reset call screen elements
            document.getElementById('callAgentName').textContent = 'Connecting...';
            document.getElementById('callStatus').textContent = 'Connecting you to Ask Microsoft Voice Agent...';
            document.getElementById('callStatus').classList.add('connecting');
            document.getElementById('callTimer').style.display = 'none';
            document.getElementById('callTranscriptArea').classList.remove('active');
            document.getElementById('callTranscriptArea').innerHTML = '';
            document.getElementById('disconnectOptions').classList.remove('active');
            document.getElementById('pulseRing').style.display = 'block';
            document.getElementById('speakerBtn').classList.remove('muted');
            document.getElementById('speakerBtn').classList.remove('is-muted');
            
            // Simulate connection
            setTimeout(() => {
                document.getElementById('callAgentName').textContent = 'Ask Microsoft Voice Agent';
                document.getElementById('callStatus').textContent = 'Starting AI voice session...';
                document.getElementById('pulseRing').style.display = 'none';
            }, 2000);
            
            // Simulate call connecting
            setTimeout(() => {
                document.getElementById('callStatus').textContent = 'Connected';
                document.getElementById('callStatus').classList.remove('connecting');
                document.getElementById('callTimer').style.display = 'block';
                document.getElementById('callTranscriptArea').classList.add('active');
                startCallTimer();
                startAIVoiceConversation();
            }, 4000);
        }

        function waitForTranscriptSpeechCompletion(text) {
            if (!audioEnabled || !isVoiceMode || !speechSynthesis) {
                return Promise.resolve();
            }

            const words = text.trim().split(/\s+/).filter(Boolean).length;
            // Neural voices average ~160 wpm = ~375ms/word; pad generously
            const estimatedMs = Math.max(1800, Math.min(20000, words * 400));
            const maxWaitMs = estimatedMs + 4000;
            const startedAt = Date.now();

            return new Promise((resolve) => {
                const checkSpeech = () => {
                    // Poke the engine awake — prevents stall when tab is backgrounded
                    try { if (speechSynthesis.paused) speechSynthesis.resume(); } catch(e) {}

                    const speakingNow = isSpeaking || speechSynthesis.speaking || speechSynthesis.pending;
                    const elapsed = Date.now() - startedAt;
                    const timedOut = elapsed > maxWaitMs;

                    // Only resolve when speech is actually done (or timed out)
                    if (timedOut) {
                        resolve();
                        return;
                    }
                    if (!speakingNow && elapsed > 600) {
                        // speech finished naturally; small grace period to avoid false negatives
                        resolve();
                        return;
                    }

                    setTimeout(checkSpeech, 80);
                };

                // Give speech engine time to start before first check
                setTimeout(checkSpeech, 400);
            });
        }

        async function startAIVoiceConversation() {
            const sessionGen = voiceSessionGeneration;
            const playLine = async (speaker, text, pauseAfterMs = 450) => {
                if (sessionGen !== voiceSessionGeneration) return;
                addCallTranscriptEntry(speaker, text);
                await waitForTranscriptSpeechCompletion(text);
                if (sessionGen !== voiceSessionGeneration) return;
                await new Promise((resolve) => setTimeout(resolve, pauseAfterMs));
            };

            // Build context-aware greeting using callback form data
            const custName = conversationContext.customerName || '';
            const bizName = conversationContext.businessName || '';
            const numUsers = conversationContext.numEmployees || null;

            if (voiceSessionContext.fromCallback && custName) {
                // Personalized greeting — we already know the customer from the callback form
                let contextGreeting = 'Hello ' + custName + ' — this is the Ask Microsoft Voice Agent. ';
                if (bizName && numUsers) {
                    contextGreeting += 'I see you\'ve requested a callback regarding Microsoft 365 for ' + bizName + ', approximately ' + numUsers + ' users. ';
                } else if (bizName) {
                    contextGreeting += 'I see you\'ve requested a callback regarding Microsoft 365 for ' + bizName + '. ';
                } else if (numUsers) {
                    contextGreeting += 'I see you\'ve requested a callback regarding Microsoft 365 for a team of approximately ' + numUsers + ' users. ';
                }
                contextGreeting += 'While your sales specialist connects with you, I\'m here to answer questions or help you explore options. How can I assist?';
                await playLine('AI Assistant', contextGreeting, 500);
                await playLine('You', 'Thanks! Yes, we\'re looking to explore Microsoft 365 options for ' + (bizName || 'our team') + '. I wanted to learn more while I wait.', 420);
            } else {
                await playLine('AI Assistant', 'Hello — this is the Ask Microsoft Voice Agent. I\'m here to help you explore Microsoft 365 options. How can I assist you today?', 500);
                await playLine('You', 'Hi, we\'re looking for Microsoft 365 licensing for our team of about 20.', 420);
                conversationContext.numEmployees = 20;
            }
            if (!conversationContext.businessType) conversationContext.businessType = bizName || null;

            const teamSize = conversationContext.numEmployees || 20;
            const bizLabel = bizName || 'your business';
            await playLine('AI Assistant', 'Great, ' + bizLabel + ' with ' + teamSize + ' employees — that\'s a perfect fit for our Business plans. Are your teams mostly in-office, fully remote, or hybrid?', 420);
            await playLine('You', 'We\'re mostly hybrid, with a few fully remote staff.', 420);
            conversationContext.workLocation = 'hybrid';

            await playLine('AI Assistant', 'That makes sense. Quick follow-up: are devices mostly company-managed, or are personal devices used too?', 450);
            await playLine('You', 'Mostly company laptops, plus some personal phones for email and Teams.', 420);
            conversationContext.securityNeeds = 'moderate';

            await playLine('AI Assistant', 'Perfect, that helps. What decision timeline are you working toward?', 420);
            await playLine('You', 'Ideally this quarter — we\'re scaling up and need to get everyone on the same platform.', 450);
            conversationContext.timeline = 'this quarter';
            conversationContext.interestedPlans = ['Business Premium'];
            conversationContext.pricePerUser = 22;
            conversationContext.monthlyTotal = teamSize * conversationContext.pricePerUser;

            await playLine('AI Assistant', 'Great — based on your team size of ' + teamSize + ', hybrid setup across warehouse and remote staff, and the device mix, Microsoft 365 Business Premium at $22 per user per month is likely a strong fit. That comes to $' + (teamSize * 22) + ' per month for your team.', 500);
            await playLine('You', 'That\'s really helpful, thanks for walking me through all of that.', 420);

            // --- QUOTING FLOW ---
            const custEmail = conversationContext.customerEmail || '';
            await playLine('AI Assistant', 'I\'d love to send you a personalized quote with that pricing breakdown so you have something concrete to share with your team. Would that be helpful?', 500);
            await playLine('You', 'Yeah, that would be great.', 420);

            if (custEmail) {
                // We already have email from callback form — use it directly
                conversationContext.quoteId = 'Q-' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '-' + String(Math.floor(Math.random() * 900) + 100);
                conversationContext.quoteGenerated = true;
                conversationContext.quoteSentToEmail = true;

                await playLine('AI Assistant', 'Perfect — I already have your email from the callback form. I\'ve just generated and sent a personalized quote to ' + custEmail + '. You should have it in your inbox shortly. It\'s valid for 30 days.', 500);
                await playLine('You', 'Oh nice, that\'s convenient. Thanks!', 420);
            } else {
                // No email on file — ask for it
                await playLine('AI Assistant', 'Sure — what\'s the best email address to send it to?', 420);
                const demoEmail = 'alex@summitgear-example.com';
                await playLine('You', 'It\'s ' + demoEmail, 420);
                conversationContext.customerEmail = demoEmail;

                conversationContext.quoteId = 'Q-' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '-' + String(Math.floor(Math.random() * 900) + 100);
                conversationContext.quoteGenerated = true;
                conversationContext.quoteSentToEmail = true;

                await playLine('AI Assistant', 'Got it — I\'ve just sent the quote to ' + demoEmail + '. You\'ll find the full pricing breakdown in your inbox. It\'s valid for 30 days.', 500);
                await playLine('You', 'That\'s great, thank you.', 420);
            }
            // --- END QUOTING FLOW ---

            // Follow-up before closing
            await playLine('AI Assistant', 'Before we wrap up — is there anything else I can help you with today?', 420);
            await playLine('You', 'No, I think that covers everything. Really appreciate it.', 420);

            await playLine('AI Assistant', 'My pleasure! Just so you know, your callback request with a Microsoft specialist is still in place — so they\'ll be reaching out to you as scheduled. They\'ll also have the quote details and a summary of our conversation so you won\'t need to repeat anything. And if you feel like we\'ve covered everything and you\'d rather cancel the callback, you\'ll have that option once we end this call.', 550);
            await playLine('You', 'That\'s really helpful. Thanks so much!', 420);

            const nameRef = custName ? (', ' + custName) : '';
            const bizRef = conversationContext.businessType ? (' helping ' + conversationContext.businessType) : '';
            await playLine('AI Assistant', 'Sounds good' + nameRef + '! It was a pleasure chatting with you. Have a wonderful day, and we look forward to' + bizRef + ' thrive with Microsoft 365.', 500);
        }

        function addCallTranscriptEntry(speaker, text) {
            const transcriptArea = document.getElementById('callTranscriptArea');
            const entry = document.createElement('div');
            entry.className = 'call-transcript-entry';
            entry.innerHTML = `
                <div class="call-transcript-speaker">${speaker}</div>
                <div class="call-transcript-text">${text}</div>
            `;
            transcriptArea.appendChild(entry);
            transcriptArea.scrollTop = transcriptArea.scrollHeight;
            
            // If this is any speaker (AI or You) and audio is enabled, use text-to-speech
            if ((speaker === 'AI Assistant' || speaker === 'You') && audioEnabled && isVoiceMode) {
                speakText(text, speaker);
            }
        }

        // --- Quote Summary Card Generator ---
        function generateQuoteCardHTML(options) {
            const ctx = conversationContext;
            const plan = (ctx.interestedPlans && ctx.interestedPlans.length > 0) ? ctx.interestedPlans[0] : 'Business Premium';
            const users = ctx.numEmployees || 20;
            const pricePerUser = ctx.pricePerUser || 22;
            const monthly = ctx.monthlyTotal || (users * pricePerUser);
            const annual = monthly * 12;
            const quoteId = ctx.quoteId || 'Q-00000000-000';
            const email = ctx.customerEmail;
            const isSent = ctx.quoteSentToEmail;
            const showEmail = options && options.showEmail !== undefined ? options.showEmail : true;
            const overrideEmail = options && options.overrideEmail ? options.overrideEmail : null;
            const displayEmail = overrideEmail || email;
            const businessName = ctx.businessName || ctx.businessType || 'Your Business';

            let badgeHTML = isSent
                ? '<span class="quote-card-badge">\ud83d\udce7 Quote Sent</span>'
                : '<span class="quote-card-badge">\ud83d\udccb Quote Generated</span>';

            let footerHTML = '';
            if (isSent && displayEmail && showEmail) {
                footerHTML = '<div class="quote-card-footer"><div class="quote-card-email">\ud83d\udce7 Sent to ' + displayEmail + '</div><div class="quote-card-validity">Valid for 30 days</div></div>';
            } else {
                footerHTML = '<div class="quote-card-footer"><div class="quote-card-validity">Valid for 30 days</div></div>';
            }

            return '<div class="quote-card ' + (isSent ? 'quote-sent-pulse' : '') + '">' +
                '<div class="quote-card-header">' + badgeHTML + '<span class="quote-card-ref">' + quoteId + '</span></div>' +
                '<div class="quote-card-grid">' +
                    '<div class="quote-card-item"><strong>Plan</strong><br/>Microsoft 365 ' + plan + '</div>' +
                    '<div class="quote-card-item"><strong>Business</strong><br/>' + businessName + '</div>' +
                    '<div class="quote-card-item"><strong>Users</strong><br/>' + users + ' users</div>' +
                    '<div class="quote-card-item"><strong>Per User</strong><br/>$' + pricePerUser + '/user/mo</div>' +
                '</div>' +
                '<div class="quote-card-total">' +
                    '<div><div class="quote-card-total-label">Monthly Total</div>' +
                    '<div style="font-size: 11px; color: #6b7280;">Annual: $' + annual.toLocaleString() + '/year</div></div>' +
                    '<div class="quote-card-total-value">$' + monthly + '/mo</div>' +
                '</div>' +
                footerHTML +
            '</div>';
        }

        function addQuoteCardToChat(options) {
            if (!conversationContext.quoteGenerated && !conversationContext.quoteReadyForSend) return;
            const html = generateQuoteCardHTML(options);
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.innerHTML = '<div class="message-bubble">' + html + '<div class="message-time">just now</div></div>';
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // --- Conversation Summary Card for Sales Associate ---
        function generateSummaryCardHTML() {
            const ctx = conversationContext;
            const parts = [];
            if (ctx.businessName || ctx.businessType) parts.push('Business: ' + (ctx.businessName || ctx.businessType));
            if (ctx.numEmployees) parts.push('Team size: ~' + ctx.numEmployees + ' employees');
            if (ctx.workLocation) parts.push('Work setup: ' + ctx.workLocation);
            if (ctx.securityNeeds) parts.push('Security priority: ' + (ctx.securityNeeds === 'high' ? 'High \u2014 handles sensitive data' : ctx.securityNeeds));
            if (ctx.timeline) parts.push('Timeline: ' + ctx.timeline);
            if (ctx.interestedPlans && ctx.interestedPlans.length > 0) parts.push('Recommended plan: Microsoft 365 ' + ctx.interestedPlans[0]);
            if (ctx.pricePerUser && ctx.numEmployees) parts.push('Pricing: $' + ctx.pricePerUser + '/user/mo \u00d7 ' + ctx.numEmployees + ' users = $' + (ctx.pricePerUser * ctx.numEmployees) + '/mo');
            if (ctx.quoteSentToEmail && ctx.customerEmail) parts.push('\u2705 Quote sent to ' + ctx.customerEmail + ' (ID: ' + ctx.quoteId + ')');

            if (parts.length === 0) return '';

            return '<div class="summary-card">' +
                '<div class="summary-card-header">\ud83d\udccb Conversation Summary (shared with your specialist)</div>' +
                '<ul class="summary-card-list">' + parts.map(function(p) { return '<li>' + p + '</li>'; }).join('') + '</ul>' +
                '<div class="summary-card-footer">This summary will be shared with the Microsoft specialist assigned to your callback so they can pick up right where we left off.</div>' +
            '</div>';
        }

        function speakText(text, speaker) {
            // Don't speak if audio is disabled or not in voice mode
            if (!audioEnabled || !isVoiceMode) {
                console.log('Speech skipped - audioEnabled:', audioEnabled, 'isVoiceMode:', isVoiceMode);
                return;
            }
            const speechGenerationAtStart = voiceSessionGeneration;
            
            // Wait for current speech to complete before starting new one
            const speakWhenReady = () => {
                if (!audioEnabled || !isVoiceMode || speechGenerationAtStart !== voiceSessionGeneration) {
                    return;
                }
                if (speechSynthesis.speaking) {
                    // Wait 100ms and try again
                    setTimeout(speakWhenReady, 100);
                    return;
                }
                if (!audioEnabled || !isVoiceMode || speechGenerationAtStart !== voiceSessionGeneration) {
                    return;
                }
                
                // Reset engine before each utterance — prevents stale queue
                try { speechSynthesis.resume(); } catch(e) {}

                const utterance = new SpeechSynthesisUtterance(text);
                
                // Configure voice settings based on speaker
                if (speaker === 'AI Assistant') {
                    utterance.rate = 1.0;   // Natural pace
                    utterance.pitch = 1.0;  // Natural pitch (Neural voices handle this well)
                } else {
                    // User's voice — slightly different rate/pitch to ensure audible contrast
                    utterance.rate = 0.95;
                    utterance.pitch = 0.9;  // Lower pitch = distinct from AI
                }
                utterance.volume = 1.0;
                
                // Get available voices
                const voices = speechSynthesis.getVoices();
                
                let preferredVoice;
                if (speaker === 'AI Assistant') {
                    // AI voice: Jenny Online primary (do NOT use Guy/Aria to avoid overlap with user)
                    preferredVoice = 
                        voices.find(v => v.name.includes('Jenny') && v.name.includes('Online')) ||
                        voices.find(v => v.name.includes('Jenny')) ||
                        voices.find(v => v.name.includes('Microsoft Zira')) ||
                        voices.find(v => v.name.includes('Google US English Female')) ||
                        voices.find(v => v.lang === 'en-US' && v.name.includes('Female')) ||
                        voices.find(v => v.lang === 'en-US' && v.localService) ||
                        voices.find(v => v.lang === 'en-US') ||
                        voices[0];
                } else {
                    // Customer — Guy/Ryan/Andrew Online (male voice, distinct from AI's Jenny)
                    preferredVoice = 
                        voices.find(v => v.name.includes('Guy') && v.name.includes('Online')) ||
                        voices.find(v => v.name.includes('Ryan') && v.name.includes('Online')) ||
                        voices.find(v => v.name.includes('Andrew') && v.name.includes('Online')) ||
                        voices.find(v => v.name.includes('Microsoft David')) ||
                        voices.find(v => v.name.includes('Google US English Male')) ||
                        voices.find(v => v.lang === 'en-US' && v.name.includes('Male')) ||
                        voices.find(v => v.lang === 'en-US') ||
                        voices[0];
                }
                
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                    console.log(`[Voice] ${speaker} → ${preferredVoice.name}`);
                }
                
                // Show speaking indicator
                utterance.onstart = function() {
                    isSpeaking = true;
                    startSpeechKeepAlive();  // prevent Chrome 15-sec cutoff
                    const indicator = document.getElementById('speakingIndicator');
                    const avatar = document.getElementById('callAvatar');
                    if (indicator) indicator.classList.add('active');
                    if (avatar) avatar.style.transform = 'scale(1.05)';
                };
                
                utterance.onend = function() {
                    isSpeaking = false;
                    stopSpeechKeepAlive();
                    const indicator = document.getElementById('speakingIndicator');
                    const avatar = document.getElementById('callAvatar');
                    if (indicator) indicator.classList.remove('active');
                    if (avatar) avatar.style.transform = 'scale(1)';
                };
                
                utterance.onerror = function(event) {
                    console.error(`Speech synthesis error for ${speaker}:`, event.error, '| Voice:', preferredVoice?.name);
                    isSpeaking = false;
                    stopSpeechKeepAlive();
                    const indicator = document.getElementById('speakingIndicator');
                    const avatar = document.getElementById('callAvatar');
                    if (indicator) indicator.classList.remove('active');
                    if (avatar) avatar.style.transform = 'scale(1)';
                    
                    // If an Online/Neural voice failed, retry with a local fallback
                    if (preferredVoice && !preferredVoice.localService) {
                        // Don't retry if session was ended (disconnect)
                        if (!audioEnabled || !isVoiceMode || speechGenerationAtStart !== voiceSessionGeneration) return;
                        console.log(`[Voice] Retrying ${speaker} with local fallback voice...`);
                        const retryUtterance = new SpeechSynthesisUtterance(text);
                        retryUtterance.rate = 1.0;
                        retryUtterance.pitch = 1.0;
                        retryUtterance.volume = 1.0;
                        const localVoices = speechSynthesis.getVoices();
                        let fallback;
                        if (speaker === 'AI Assistant') {
                            fallback = localVoices.find(v => v.name.includes('Microsoft Zira') && v.localService) ||
                                       localVoices.find(v => v.lang === 'en-US' && v.localService);
                        } else {
                            fallback = localVoices.find(v => v.name.includes('Microsoft David') && v.localService) ||
                                       localVoices.find(v => v.lang === 'en-US' && v.localService && v.name.includes('Male'));
                        }
                        if (fallback) {
                            retryUtterance.voice = fallback;
                            console.log(`[Voice] Fallback → ${fallback.name}`);
                        }
                        retryUtterance.onstart = utterance.onstart;
                        retryUtterance.onend = utterance.onend;
                        retryUtterance.onerror = () => { isSpeaking = false; };
                        try { speechSynthesis.speak(retryUtterance); } catch(e) {}
                    }
                };
                
                // Speak the text
                try {
                    speechSynthesis.speak(utterance);
                } catch (error) {
                    console.error('Speech synthesis failed:', error);
                }
            };
            
            // Start speaking when ready
            speakWhenReady();
        }

        function toggleSpeaker() {
            audioEnabled = !audioEnabled;
            const speakerBtn = document.getElementById('speakerBtn');
            if (!speakerBtn) return;
            
            if (!audioEnabled) {
                speakerBtn.classList.add('muted');
                speakerBtn.classList.add('is-muted');
                speakerBtn.title = 'Unmute Speaker';
                // Stop any current speech
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
                const indicator = document.getElementById('speakingIndicator');
                if (indicator) indicator.classList.remove('active');
                addCallTranscriptEntry('System', '🔇 Speaker muted');
            } else {
                speakerBtn.classList.remove('muted');
                speakerBtn.classList.remove('is-muted');
                speakerBtn.title = 'Mute Speaker';
                addCallTranscriptEntry('System', '🔊 Speaker active');
            }
        }

        function toggleMuteCall() {
            isMuted = !isMuted;
            const muteBtn = document.getElementById('muteBtnCall');
            if (!muteBtn) return;
            
            muteBtn.style.background = isMuted ? 'rgba(239, 68, 68, 0.8)' : 'rgba(255, 255, 255, 0.2)';
            muteBtn.classList.toggle('muted', isMuted);
            muteBtn.classList.toggle('is-muted', isMuted);
            
            if (isMuted) {
                addCallTranscriptEntry('System', '🔇 Microphone muted');
            } else {
                addCallTranscriptEntry('System', '🎤 Microphone active');
            }
        }

        function endAICall() {
            // Disable voice mode to prevent new audio from starting
            isVoiceMode = false;
            audioEnabled = false;
            isSpeaking = false;
            voiceSessionGeneration++;
            stopSpeechKeepAlive();  // clean up keepalive timer
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            // Stop any ongoing speech immediately and forcefully
            try {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
                // Call cancel again to ensure it stops
                speechSynthesis.cancel();
            } catch (e) {
                console.error('Error stopping speech:', e);
            }
            
            // Hide call controls and info immediately
            const callAgentName = document.getElementById('callAgentName');
            const callStatus = document.getElementById('callStatus');
            const callTimerEl = document.getElementById('callTimer');
            const callControls = document.querySelector('.call-controls');
            const callAvatar = document.getElementById('callAvatar');
            const speakingIndicator = document.getElementById('speakingIndicator');
            const transcriptArea = document.getElementById('callTranscriptArea');
            
            if (callAgentName) callAgentName.style.display = 'none';
            if (callStatus) callStatus.style.display = 'none';
            if (callTimerEl) callTimerEl.style.display = 'none';
            if (callControls) callControls.style.display = 'none';
            if (callAvatar) {
                callAvatar.style.display = 'none';
                callAvatar.style.transform = 'scale(1)';
            }
            if (speakingIndicator) speakingIndicator.classList.remove('active');
            if (transcriptArea) transcriptArea.style.display = 'none';
            
            // Check if we came from callback flow - if so, show wrap-up in chat
            if (callbackRequested && voiceSessionContext.fromCallback) {
                closeCallScreen();
                showVoiceWrapUpScreen();
            } else if (voiceSessionContext.fromOffHoursAiFirst) {
                closeCallScreen();
                showOffHoursAiFirstWrapUpScreen();
            } else {
                // Original behavior: show disconnect options on call screen
                const disconnectOptions = document.getElementById('disconnectOptions');
                if (disconnectOptions) {
                    disconnectOptions.classList.add('active');
                }
            }
        }

        const brandCloseText = "Thanks for considering Microsoft 365 for your business.";

        function showOffHoursAiFirstOffer() {
            const optionsHTML = `
                <div class="hours-notice" style="margin: 0 0 12px 0;">
                    <div class="hours-title">Business hours notice</div>
                    <div>You've reached us outside of business hours (M-F, 6 AM to 6 PM PT). I'm still here to help — please choose one of the options below.</div>
                </div>
                <div style="margin: 4px 0 12px 0; font-size: 14px; color: #555555; line-height: 1.6;">
                    If you'd like immediate help, you can speak with our Ask Microsoft Voice Agent now.
                    <br/><br/>
                    You can also request a callback from a Microsoft specialist.
                </div>
                <div class="options-container">
                    <div class="chat-option-card" onclick="handleOffHoursAiFirstSpeakNow()" role="button" tabindex="0" style="border-color: #0f6cbd; background: #e1efff; box-shadow: 0 10px 24px rgba(15, 108, 189, 0.24);">
                        <div class="chat-option-icon" style="background: white;">
                            <img src="voice.png" alt="Ask Microsoft Voice Agent" style="width: 44px; height: 44px; display: block;" />
                        </div>
                        <div class="chat-option-content">
                            <div class="chat-option-title">Speak with Ask Microsoft Voice Agent</div>
                            <div class="chat-option-description">Available immediately. Get answers to product and plan questions through an interactive voice conversation.</div>
                        </div>
                    </div>
                    <div class="chat-option-card" onclick="handleOffHoursAiFirstCallback()" role="button" tabindex="0" style="opacity: 0.72; border-color: #e5e5e5;">
                        <div class="chat-option-icon">
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M6.6 10.8a12.4 12.4 0 0 0 6.6 6.6l2.2-2.2a1 1 0 0 1 1-.24c1.1.36 2.3.56 3.6.56a1 1 0 0 1 1 1v3.5a1 1 0 0 1-1 1C10.1 21 3 13.9 3 5.9a1 1 0 0 1 1-1H7.5a1 1 0 0 1 1 1c0 1.3.2 2.5.56 3.6a1 1 0 0 1-.24 1l-2.2 2.2z"/>
                            </svg>
                        </div>
                        <div class="chat-option-content">
                            <div class="chat-option-title">Request a Callback</div>
                            <div class="chat-option-description">A Microsoft sales associate will contact you within 48 hours to discuss your needs.</div>
                        </div>
                    </div>
                </div>
            `;

            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${optionsHTML}
                    <div class="message-time">just now</div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function handleOffHoursAiFirstSpeakNow() {
            addMessage('I\'d like to speak with the Ask Microsoft Voice Agent now', 'user');
            setTimeout(() => {
                addMessage('Absolutely. Connecting you to our Ask Microsoft Voice Agent now.', 'bot', false);
                setTimeout(() => {
                    voiceSessionContext.fromCallback = false;
                    voiceSessionContext.fromOffHoursAiFirst = true;
                    startVoiceSession();
                }, 800);
            }, 400);
        }

        function handleOffHoursAiFirstCallback() {
            addMessage('I\'d like to request a callback', 'user');
            setTimeout(() => {
                addMessage('I\'ll help you request a callback. Please provide some information so our sales team can reach out to you.', 'bot', false);
                setTimeout(() => {
                    showCallbackForm();
                }, 800);
            }, 400);
        }

        function showVoiceWrapUpScreen() {
            // SCREEN 1: Voice Wrap-Up — compact summary with buttons visible immediately
            const durationMin = Math.floor(callDuration / 60);
            const durationSec = callDuration % 60;
            const durationText = durationMin > 0
                ? durationMin + ' min ' + durationSec + ' sec'
                : durationSec + ' sec';

            // Build compact summary lines
            let summaryLines = '';
            summaryLines += '<div style="display: flex; align-items: center; gap: 8px; padding: 6px 0;"><span style="color: #16a34a; font-size: 16px;">✅</span><span>Callback request submitted</span></div>';
            summaryLines += '<div style="display: flex; align-items: center; gap: 8px; padding: 6px 0;"><span style="color: #0f6cbd; font-size: 16px;">🎙️</span><span>Connected with Ask Microsoft Voice Agent <span style="color: #888; font-size: 12px;">(Duration: ' + durationText + ')</span></span></div>';
            if (conversationContext.quoteSentToEmail && conversationContext.customerEmail) {
                summaryLines += '<div style="display: flex; align-items: center; gap: 8px; padding: 6px 0;"><span style="color: #16a34a; font-size: 16px;">📧</span><span>Personalized quote sent to <strong>' + conversationContext.customerEmail + '</strong></span></div>';
            }
            summaryLines += '<div style="display: flex; align-items: center; gap: 8px; padding: 6px 0;"><span style="color: #f59e0b; font-size: 16px;">📞</span><span>Callback status: <strong style="color: #0f6cbd;">Scheduled</strong> — a specialist will follow up</span></div>';

            const optionsHTML = `
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 14px;">
                    <button style="
                        background: #0f6cbd;
                        color: white;
                        border: none;
                        padding: 10px 16px;
                        border-radius: 4px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: background 0.2s;
                    " 
                    onmouseover="this.style.background='#0d4f99'" 
                    onmouseout="this.style.background='#0f6cbd'"
                    onclick="handleKeepCallback()">
                        ✓ Keep My Callback
                    </button>
                    <button style="
                        background: white;
                        color: #0f6cbd;
                        border: 1.5px solid #0f6cbd;
                        padding: 10px 16px;
                        border-radius: 4px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.2s;
                    " 
                    onmouseover="this.style.background='#f0f8ff'" 
                    onmouseout="this.style.background='white'"
                    onclick="handleCancelCallback()">
                        I'm All Set for Now
                    </button>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #888888; font-style: italic;">
                    You can request a specialist at any time.
                </div>
            `;
            
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div style="font-size: 16px; font-weight: 600; color: #262626;">Thanks for speaking with our Ask Microsoft Voice Agent.</div>
                    <div style="margin-top: 12px; font-size: 13px; color: #444; line-height: 1.6; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px 14px; background: #fafafa;">
                        ${summaryLines}
                    </div>
                    <div style="margin-top: 12px; font-size: 14px; color: #555; font-weight: 500;">You're in control — please choose what works best for you.</div>
                    ${optionsHTML}
                    <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid #e8e8e8; font-size: 13px; color: #666666; font-style: italic;">
                        ${brandCloseText}
                    </div>
                    <div class="message-time">just now</div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function handleKeepCallback() {
            // User chose to keep callback - show confirmation screen
            addMessage('Keep my callback request', 'user');
            setTimeout(() => {
                showKeepCallbackConfirmation();
            }, 500);
        }

        function showOffHoursAiFirstWrapUpScreen() {
            const optionsHTML = `
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 12px;">
                    <button style="
                        background: #0f6cbd;
                        color: white;
                        border: none;
                        padding: 10px 16px;
                        border-radius: 4px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: background 0.2s;
                    " 
                    onmouseover="this.style.background='#0d4f99'" 
                    onmouseout="this.style.background='#0f6cbd'"
                    onclick="handleOffHoursPostVoiceCallback()">
                        Request a Callback
                    </button>
                    <button style="
                        background: white;
                        color: #0f6cbd;
                        border: 1.5px solid #0f6cbd;
                        padding: 10px 16px;
                        border-radius: 4px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.2s;
                    " 
                    onmouseover="this.style.background='#f0f8ff'" 
                    onmouseout="this.style.background='white'"
                    onclick="handleOffHoursPostVoiceAllSet()">
                        I'm All Set for Now
                    </button>
                </div>
                <div style="margin-top: 14px; font-size: 12px; color: #888888; font-style: italic;">
                    You can request a specialist at any time.
                </div>
            `;

            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div style="font-size: 16px; font-weight: 600; color: #262626;">Thanks for speaking with our Ask Microsoft Voice Agent.</div>
                    <div style="margin-top: 12px; font-size: 14px; color: #555555; line-height: 1.6;">
                        I hope this conversation was helpful.<br/><br/>
                        If you'd still like to connect with a Microsoft specialist, you can request a callback below.<br/><br/>
                        <span style="font-weight: 500; color: #262626;">You're in control — please choose what works best for you.</span>
                    </div>
                    ${optionsHTML}
                    <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid #e8e8e8; font-size: 13px; color: #666666; font-style: italic;">
                        ${brandCloseText}
                    </div>
                    <div class="message-time">just now</div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
            voiceSessionContext.fromOffHoursAiFirst = false;
        }

        function handleOffHoursPostVoiceCallback() {
            addMessage('Request a callback', 'user');
            callbackFlowContext = 'offHoursAiFirstPostVoice';
            setTimeout(() => {
                showCallbackForm();
            }, 500);
        }

        function handleOffHoursPostVoiceAllSet() {
            addMessage("I'm all set for now", 'user');
            voiceSessionContext.fromOffHoursAiFirst = false;
            setTimeout(() => {
                addMessage('Thanks for letting me know. If anything comes up, I\'m here to help.', 'bot', false);
            }, 500);
        }

        function showOffHoursCallbackConfirmation() {
            const optionsHTML = `
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 12px;">
                    <button style="
                        background: #0f6cbd;
                        color: white;
                        border: none;
                        padding: 10px 16px;
                        border-radius: 4px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: background 0.2s;
                    " 
                    onmouseover="this.style.background='#0d4f99'" 
                    onmouseout="this.style.background='#0f6cbd'"
                    onclick="continueExploring()">
                        Continue Exploring
                    </button>
                    <button style="
                        background: white;
                        color: #0f6cbd;
                        border: 1.5px solid #0f6cbd;
                        padding: 10px 16px;
                        border-radius: 4px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.2s;
                    " 
                    onmouseover="this.style.background='#f0f8ff'" 
                    onmouseout="this.style.background='white'"
                    onclick="startNewConversation()">
                        Start a New Conversation
                    </button>
                </div>
            `;

            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div style="font-size: 16px; font-weight: 600; color: #262626;">Your callback request has been received.</div>
                    <div style="margin-top: 12px; font-size: 14px; color: #555555; line-height: 1.6;">
                        A Microsoft specialist will follow up within 48 hours. In the meantime, feel free to continue exploring.
                    </div>
                    ${optionsHTML}
                    <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid #e8e8e8; font-size: 13px; color: #666666; font-style: italic;">
                        ${brandCloseText}
                    </div>
                    <div class="message-time">just now</div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function showKeepCallbackConfirmation() {
            // SCREEN 2: Keep Callback Confirmation — compact with summary shared to sales associate
            const summaryHTML = generateSummaryCardHTML();

            const optionsHTML = `
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 12px;">
                    <button style="
                        background: #0f6cbd;
                        color: white;
                        border: none;
                        padding: 10px 16px;
                        border-radius: 4px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: background 0.2s;
                    " 
                    onmouseover="this.style.background='#0d4f99'" 
                    onmouseout="this.style.background='#0f6cbd'"
                    onclick="continueExploring()">
                        Continue Exploring
                    </button>
                    <button style="
                        background: white;
                        color: #0f6cbd;
                        border: 1.5px solid #0f6cbd;
                        padding: 10px 16px;
                        border-radius: 4px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.2s;
                    " 
                    onmouseover="this.style.background='#f0f8ff'" 
                    onmouseout="this.style.background='white'"
                    onclick="startNewConversation()">
                        Start a New Conversation
                    </button>
                </div>
            `;
            
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div style="font-size: 16px; font-weight: 600; color: #262626;">Great — your callback request remains scheduled.</div>
                    <div style="margin-top: 12px; font-size: 14px; color: #555555; line-height: 1.6;">
                        A Microsoft specialist will follow up as planned. We've shared the conversation summary and quote details with them so they can pick up right where you left off — you won't need to repeat anything.
                    </div>
                    ${summaryHTML}
                    ${optionsHTML}
                    <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid #e8e8e8; font-size: 13px; color: #666666; font-style: italic;">
                        ${brandCloseText}
                    </div>
                    <div class="message-time">just now</div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function handleCancelCallback() {
            // User chose "I'm All Set for Now" - cancel and show confirmation
            callbackRequested = false;
            callbackRequestedAfterVoiceCall = false;
            voiceSessionContext.fromCallback = false;
            addMessage("I'm all set for now", 'user');
            setTimeout(() => {
                showCancelCallbackConfirmation();
            }, 500);
        }

        function showCancelCallbackConfirmation() {
            // SCREEN 3: Cancel Callback Confirmation
            const optionsHTML = `
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 12px;">
                    <button style="
                        background: #0f6cbd;
                        color: white;
                        border: none;
                        padding: 10px 16px;
                        border-radius: 4px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: background 0.2s;
                    " 
                    onmouseover="this.style.background='#0d4f99'" 
                    onmouseout="this.style.background='#0f6cbd'"
                    onclick="continueExploring()">
                        Continue Exploring
                    </button>
                    <button style="
                        background: white;
                        color: #0f6cbd;
                        border: 1.5px solid #0f6cbd;
                        padding: 10px 16px;
                        border-radius: 4px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.2s;
                    " 
                    onmouseover="this.style.background='#f0f8ff'" 
                    onmouseout="this.style.background='white'"
                    onclick="startNewConversation()">
                        Start a New Conversation
                    </button>
                </div>
            `;
            
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div style="font-size: 16px; font-weight: 600; color: #262626;">No problem at all.</div>
                    <div style="margin-top: 12px; font-size: 14px; color: #555555; line-height: 1.6;">
                        Your callback request has been cancelled. If you'd like to reconnect with a Microsoft specialist later, you can request a callback anytime.
                    </div>
                    ${optionsHTML}
                    <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid #e8e8e8; font-size: 13px; color: #666666; font-style: italic;">
                        ${brandCloseText}
                    </div>
                    <div class="message-time">just now</div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function continueExploring() {
            addMessage('Continue exploring', 'user');
            setTimeout(() => {
                addMessage('Great! Feel free to ask me any questions about Microsoft 365 — pricing, features, security, or anything else. What would you like to know?', 'bot', false);
            }, 500);
        }

        function resetChatForVariantSwitch() {
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }

            callDuration = 0;
            isHumanAgent = false;
            conversation = [];
            isMuted = false;
            isVoiceMode = false;
            voiceMuted = false;
            isSpeaking = false;
            audioEnabled = true;
            callbackRequested = false;
            callbackRequestedAfterVoiceCall = false;
            offHoursAiFirstFlow = false;
            callbackFlowContext = null;
            voiceSessionContext = { fromCallback: false, fromOffHoursAiFirst: false };
            conversationContext = {
                numEmployees: null,
                workLocation: null,
                securityNeeds: null,
                timeline: null,
                interestedPlans: []
            };

            try {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
                speechSynthesis.cancel();
            } catch (e) {
                console.error('Error stopping speech:', e);
            }

            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('messageInput');
            const quickActions = document.getElementById('quickActions');
            const disclaimer = document.querySelector('.disclaimer');
            const chatInputArea = document.querySelector('.chat-input-area');
            const agentAvatar = document.getElementById('agentAvatar');
            const agentName = document.getElementById('agentName');
            const handoffBanner = document.getElementById('handoffBanner');
            const voiceInterface = document.getElementById('voiceInterface');
            const voiceTranscript = document.getElementById('voiceTranscript');
            const callScreen = document.getElementById('callScreen');
            const callAgentName = document.getElementById('callAgentName');
            const callStatus = document.getElementById('callStatus');
            const callTimerEl = document.getElementById('callTimer');
            const callTranscriptArea = document.getElementById('callTranscriptArea');

            if (chatMessages) {
                chatMessages.innerHTML = `
                    <div class="message bot">
                        <div class="message-bubble">
                            Hi. I'm an AI agent, I can help you compare plans and features, start a free trial, answer support questions or connect you with a Microsoft Sales Representative. You can also request a sales call <a href="https://www.microsoft.com/en-us/microsoft-365/microsoft-365-business" target="_blank" rel="noopener noreferrer">here</a> or call us at (800) 642-7676 M-F 6 AM to 6 PM PT. What can I do for you?
                            <br><br>
                            To learn more about this AI web feature, read the <a href="https://aka.ms/AITransparencyFAQ" target="_blank" rel="noopener noreferrer">Transparency FAQ (PDF)</a>.
                            <div class="message-time">just now</div>
                            <div class="feedback-buttons">
                                <button class="feedback-btn" onclick="giveFeedback('helpful')" title="Helpful">👍</button>
                                <button class="feedback-btn" onclick="giveFeedback('not-helpful')" title="Not helpful">👎</button>
                            </div>
                        </div>
                    </div>
                `;
                chatMessages.style.display = 'block';
            }

            if (chatInput) {
                chatInput.value = '';
            }

            if (quickActions) {
                quickActions.style.display = 'flex';
            }

            if (disclaimer) {
                disclaimer.style.display = 'block';
            }

            if (chatInputArea) {
                chatInputArea.style.display = 'flex';
            }

            if (agentAvatar) {
                agentAvatar.innerHTML = '<img src="Icon.jpg" alt="Ask Microsoft" />';
            }

            if (agentName) {
                agentName.textContent = 'Ask Microsoft';
            }

            if (handoffBanner) {
                handoffBanner.classList.remove('active');
            }

            if (voiceInterface) {
                voiceInterface.classList.remove('active');
            }

            if (voiceTranscript) {
                voiceTranscript.innerHTML = '';
            }

            if (callScreen) {
                callScreen.classList.remove('active');
            }

            if (callAgentName) {
                callAgentName.textContent = 'Connecting...';
            }

            if (callStatus) {
                callStatus.textContent = 'Connecting you to Ask Microsoft Voice Agent...';
                callStatus.classList.add('connecting');
            }

            if (callTimerEl) {
                callTimerEl.style.display = 'none';
                callTimerEl.textContent = '00:00';
            }

            if (callTranscriptArea) {
                callTranscriptArea.innerHTML = '';
            }

            const modalsToClose = [
                'choiceModal',
                'salesOptionsModal',
                'callbackFormModal',
                'callbackConfirmationModal',
                'speakWhileYouWaitModal'
            ];

            modalsToClose.forEach((modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('active');
                }
            });

            const callbackForm = document.getElementById('callbackForm');
            if (callbackForm) {
                callbackForm.reset();
            }
        }

        function startNewConversation() {
            // Reset conversation context and show welcome message
            conversation = [];
            callbackRequested = false;
            callbackRequestedAfterVoiceCall = false;
            voiceSessionContext.fromCallback = false;
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            addMessage('Start a new conversation', 'user');
            setTimeout(() => {
                addMessage('Hi there! 👋 I\'m an AI agent here to help you explore Microsoft 365. How can I assist you today?', 'bot', false);
                setTimeout(() => {
                    addMessage('You can ask me about plans and pricing, features, security, migration, trials, or request to speak with a sales specialist. What interests you most?', 'bot', false);
                }, 1000);
            }, 500);
        }

        function requestCallbackAfterCall() {
            // Stop any ongoing speech before closing
            isVoiceMode = false;
            audioEnabled = false;
            voiceSessionGeneration++;
            callbackRequestedAfterVoiceCall = true;
            try {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
                speechSynthesis.cancel();
            } catch (e) {
                console.error('Error stopping speech:', e);
            }
            
            closeCallScreen();
            setTimeout(() => {
                addMessage('I\'d like to request a callback from a sales specialist', 'user');
                setTimeout(() => {
                    addMessage('Great! Let me help you with that. Please provide some information so our sales team can reach out to you.', 'bot', false);
                    setTimeout(() => {
                        showCallbackForm();
                    }, 1000);
                }, 500);
            }, 500);
        }

        function closeCallScreen() {
            const callScreen = document.getElementById('callScreen');
            callScreen.classList.remove('active');
            isVoiceMode = false;
            isMuted = false;
            isSpeaking = false;
            voiceSessionGeneration++;
            
            // Stop any ongoing speech forcefully
            try {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
                speechSynthesis.cancel();
            } catch (e) {
                console.error('Error stopping speech:', e);
            }
            
            // Re-enable audio for future calls
            audioEnabled = true;
            
            // Reset UI elements
            const callAgentName = document.getElementById('callAgentName');
            const callStatus = document.getElementById('callStatus');
            const callControls = document.querySelector('.call-controls');
            const callAvatar = document.getElementById('callAvatar');
            const disconnectOptions = document.getElementById('disconnectOptions');
            const muteBtnCall = document.getElementById('muteBtnCall');
            const speakerBtn = document.getElementById('speakerBtn');
            const speakingIndicator = document.getElementById('speakingIndicator');
            const transcriptArea = document.getElementById('callTranscriptArea');
            
            if (callAgentName) callAgentName.style.display = 'block';
            if (callStatus) callStatus.style.display = 'block';
            if (callControls) callControls.style.display = 'flex';
            if (callAvatar) {
                callAvatar.style.display = 'flex';
                callAvatar.style.transform = 'scale(1)';
            }
            if (transcriptArea) transcriptArea.style.display = 'block';
            if (disconnectOptions) disconnectOptions.classList.remove('active');
            if (muteBtnCall) {
                muteBtnCall.style.background = 'rgba(255, 255, 255, 0.2)';
                muteBtnCall.classList.remove('muted');
                muteBtnCall.classList.remove('is-muted');
            }
            if (speakerBtn) {
                speakerBtn.classList.remove('muted');
                speakerBtn.classList.remove('is-muted');
            }
            if (speakingIndicator) speakingIndicator.classList.remove('active');
            
            // Add message to chat
            const minutes = Math.floor(callDuration / 60);
            const seconds = callDuration % 60;
            addSystemMessage(`🤖 Ask Microsoft Voice Agent call ended (Duration: ${minutes}m ${seconds}s)`);
        }

        function startVoiceConversation() {
            const transcript = document.getElementById('voiceTranscript');
            
            // Initial greeting
            addTranscriptEntry('AI Assistant', 'Hello! I\'m your Ask Microsoft Voice Agent for Microsoft 365 Business. I\'m here to help you find the right plan for your business. To get started, could you tell me a bit about your company? How many employees do you have?');
            
            // Simulate an interactive conversation flow
            setTimeout(() => {
                addTranscriptEntry('You', 'We have about 15 people on our team.');
                conversationContext.numEmployees = 15;
                
                setTimeout(() => {
                    addTranscriptEntry('AI Assistant', 'Perfect! A 15-person team is ideal for our Microsoft 365 Business offerings. Are your employees primarily working in the office, remotely, or a hybrid setup?');
                    
                    setTimeout(() => {
                        addTranscriptEntry('You', 'We\'re mostly remote with some hybrid workers.');
                        conversationContext.workLocation = 'hybrid/remote';
                        
                        setTimeout(() => {
                            addTranscriptEntry('AI Assistant', 'That\'s very common these days. Microsoft 365 is excellent for remote and hybrid teams with Microsoft Teams for collaboration and OneDrive for cloud storage. Now, how important is security to your organization? Do you handle sensitive customer data or have any specific compliance requirements?');
                            
                            setTimeout(() => {
                                addTranscriptEntry('You', 'Security is pretty important to us. We handle some customer information.');
                                conversationContext.securityNeeds = 'high';
                                
                                setTimeout(() => {
                                    addTranscriptEntry('AI Assistant', 'I completely understand. Security is critical for protecting customer information. Based on what you\'ve shared - a 15-person team working remotely with security needs - I\'d recommend Microsoft 365 Business Premium. It includes advanced threat protection, device management, data loss prevention, and all the productivity apps like Word, Excel, PowerPoint, Teams, and 1TB of OneDrive storage per user. What\'s your timeline for making a decision?');
                                    
                                    setTimeout(() => {
                                        addTranscriptEntry('You', 'We\'re looking to move forward pretty soon, maybe this month.');
                                        conversationContext.timeline = 'this month';
                                        
                                        setTimeout(() => {
                                            addTranscriptEntry('AI Assistant', 'That\'s great to hear you\'re ready to move forward! I can connect you with a Microsoft specialist who can help finalize the next steps, provide detailed pricing for your specific needs, and ensure you get the right setup for your team. Would you like me to arrange a callback?');
                                            
                                            setTimeout(() => {
                                                addTranscriptEntry('You', 'Yes, that would be helpful. What about pricing? Can you give me an idea of the costs?');
                                                
                                                setTimeout(() => {
                                                    addTranscriptEntry('AI Assistant', 'Microsoft 365 Business Premium is $22 per user per month. For your 15-person team, that would be $330 per month. However, a Microsoft specialist can discuss volume licensing, payment options, and help you understand the full value. They\'ll also make sure you\'re aware of any current promotions. Shall I set up that callback for you?');
                                                    
                                                    setTimeout(() => {
                                                        addTranscriptEntry('You', 'Yes, please set up the callback.');
                                                        
                                                        setTimeout(() => {
                                                            addTranscriptEntry('AI Assistant', 'Perfect! I\'ll transition you to our callback request form to capture your details. A Microsoft sales associate will reach out to you within 48 hours to discuss your specific needs and next steps. Let me switch you over now.');
                                                            
                                                            setTimeout(() => {
                                                                endVoiceSession();
                                                                setTimeout(() => {
                                                                    showCallbackForm();
                                                                }, 500);
                                                            }, 2000);
                                                        }, 2000);
                                                    }, 2500);
                                                }, 2500);
                                            }, 2500);
                                        }, 2500);
                                    }, 2500);
                                }, 2500);
                            }, 2500);
                        }, 2500);
                    }, 2500);
                }, 2500);
            }, 2000);
        }

        function addTranscriptEntry(speaker, text) {
            const transcript = document.getElementById('voiceTranscript');
            const entry = document.createElement('div');
            entry.className = 'transcript-entry';
            entry.innerHTML = `
                <div class="transcript-speaker">${speaker}</div>
                <div class="transcript-text">${text}</div>
            `;
            transcript.appendChild(entry);
            transcript.scrollTop = transcript.scrollHeight;
        }

        function handleVoiceInput(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            
            // Handle common M365 questions
            if (lowerMessage.includes('difference between') && (lowerMessage.includes('standard') || lowerMessage.includes('premium'))) {
                addTranscriptEntry('AI Assistant', 'Great question! Microsoft 365 Business Standard includes all the core productivity apps like Word, Excel, PowerPoint, Outlook, and Teams, plus 1TB of cloud storage and email hosting for $12.50 per user per month. Business Premium, at $22 per user per month, includes everything in Standard plus advanced security features like advanced threat protection, device management, and data loss prevention. For businesses handling sensitive data or those with security compliance needs, Premium is the better choice.');
                return;
            }

            if (lowerMessage.includes('what') && lowerMessage.includes('plan') && lowerMessage.includes('best')) {
                addTranscriptEntry('AI Assistant', 'To recommend the best plan for you, I\'d like to know a bit more about your business. How many employees do you have, and what are your primary needs - basic productivity tools, or do you also need advanced security and compliance features?');
                return;
            }

            if (lowerMessage.includes('security') && lowerMessage.includes('add')) {
                addTranscriptEntry('AI Assistant', 'Microsoft 365 Business Premium includes comprehensive security features built-in, including Microsoft Defender for Business, which provides threat protection, device management, and data loss prevention. For most small to medium businesses, the security in Premium is sufficient. However, if you have specific compliance requirements or need advanced security management, a specialist can help assess your needs. Would you like me to connect you with someone who can provide a detailed security assessment?');
                return;
            }
            
            // Handle callback request during voice conversation
            if (lowerMessage.includes('callback') || lowerMessage.includes('specialist') || lowerMessage.includes('representative')) {
                addTranscriptEntry('AI Assistant', 'I understand you\'d like to speak with a Microsoft specialist. I can arrange a callback for you right away. Would you like me to do that?');
                return;
            }
            
            // Handle discount/pricing questions
            if (lowerMessage.includes('discount') || lowerMessage.includes('deal') || lowerMessage.includes('cheaper') || lowerMessage.includes('negotiate')) {
                addTranscriptEntry('AI Assistant', 'I\'m not able to adjust pricing or negotiate discounts. A Microsoft specialist can help you with detailed pricing, volume licensing options, and make sure you\'re aware of any current promotions or special offers. Would you like me to arrange a callback with a specialist?');
                return;
            }
            
            // Handle purchase intent
            if (lowerMessage.includes('move forward') || lowerMessage.includes('purchase') || lowerMessage.includes('buy') || lowerMessage.includes('sign up')) {
                addTranscriptEntry('AI Assistant', 'That\'s excellent! I\'m glad I could help you find the right solution. To finalize your purchase and get your team set up, I\'ll connect you with a Microsoft specialist who can process your order, help with onboarding, and answer any final questions. Would you like me to arrange that callback now?');
                return;
            }
            
            // Number of employees
            if (lowerMessage.match(/\d+/) && (lowerMessage.includes('employee') || lowerMessage.includes('people') || lowerMessage.includes('user'))) {
                const num = lowerMessage.match(/\d+/)[0];
                conversationContext.numEmployees = parseInt(num);
                addTranscriptEntry('AI Assistant', `Perfect! For a ${num}-person business, Microsoft 365 Business plans are ideal. Are your employees primarily working in the office, remotely, or a hybrid setup?`);
                return;
            }
            
            // Work location
            if (lowerMessage.includes('remote') || lowerMessage.includes('hybrid') || lowerMessage.includes('office') || lowerMessage.includes('home')) {
                conversationContext.workLocation = lowerMessage.includes('remote') ? 'remote' : lowerMessage.includes('hybrid') ? 'hybrid' : 'office';
                addTranscriptEntry('AI Assistant', 'That\'s helpful to know. Microsoft 365 works great for all work environments with cloud-based collaboration tools. Now, how important is security to your organization? Do you handle sensitive customer data?');
                return;
            }
            
            // Security needs
            if ((lowerMessage.includes('security') || lowerMessage.includes('secure') || lowerMessage.includes('important') || lowerMessage.includes('yes')) && conversationContext.securityNeeds === null) {
                conversationContext.securityNeeds = 'high';
                addTranscriptEntry('AI Assistant', 'Security is definitely critical. For organizations with security concerns, I\'d strongly recommend Microsoft 365 Business Premium. It includes advanced threat protection, device management, and data loss prevention to keep your data safe. What\'s your timeline for making a decision?');
                return;
            }

            // Timeline
            if (lowerMessage.includes('soon') || lowerMessage.includes('month') || lowerMessage.includes('week') || lowerMessage.includes('asap')) {
                conversationContext.timeline = lowerMessage.includes('week') ? 'this week' : 'soon';
                addTranscriptEntry('AI Assistant', 'Great timing! I can help expedite your setup. Based on your needs, I recommend connecting with a Microsoft specialist who can finalize everything quickly and get your team up and running. Shall I arrange that for you?');
                return;
            }
            
            // Default helpful response
            addTranscriptEntry('AI Assistant', 'I see. Let me provide some additional context. Microsoft 365 Business offers three main plans: Basic ($6/user/month) for web-only apps, Standard ($12.50/user/month) with desktop apps and email, and Premium ($22/user/month) with advanced security. Based on what you\'ve shared, would you like a specific recommendation, or would you prefer to speak with a Microsoft specialist for a more detailed consultation?');
        }

        function toggleVoiceMute() {
            voiceMuted = !voiceMuted;
            const btn = document.getElementById('voiceMuteBtn');
            btn.textContent = voiceMuted ? '🔇' : '🎤';
            btn.classList.toggle('muted');
            
            if (voiceMuted) {
                addTranscriptEntry('System', 'Microphone muted');
            } else {
                addTranscriptEntry('System', 'Microphone active');
            }
        }

        function endVoiceSession() {
            isVoiceMode = false;
            voiceMuted = false;
            stopSpeechKeepAlive();  // clean up keepalive timer
            document.getElementById('agentName').textContent = 'Ask Microsoft';
            
            // Add summary to chat
            addSystemMessage('🤖 Ask Microsoft Voice Agent session ended. Transcript saved.');
            
            // Copy transcript to chat as a system message
            const transcriptEntries = document.querySelectorAll('.transcript-entry');
            if (transcriptEntries.length > 0) {
                addMessage('Thank you for speaking with our Ask Microsoft Voice Agent! If you need further assistance, feel free to ask or request a callback with a Microsoft specialist.', 'bot', true);
            }
            
            // Reset interface
            document.getElementById('voiceInterface').classList.remove('active');
            document.getElementById('chatMessages').style.display = 'block';
            document.getElementById('disclaimer').style.display = 'block';
            document.querySelector('.chat-input-area').style.display = 'flex';
            document.getElementById('voiceTranscript').innerHTML = '';
            document.getElementById('voiceMuteBtn').textContent = '🎤';
            document.getElementById('voiceMuteBtn').classList.remove('muted');
        }

        function toggleBackToChat() {
            addTranscriptEntry('AI Assistant', 'Switching to text chat. Your conversation history is saved. How else can I help you?');
            
            setTimeout(() => {
                endVoiceSession();
            }, 1500);
        }

        function showChoiceModal() {
            document.getElementById('choiceModal').classList.add('active');
        }

        function closeChoiceModal() {
            document.getElementById('choiceModal').classList.remove('active');
        }

        function selectConnectionType(type) {
            closeChoiceModal();
            
            if (type === 'chat') {
                handoffToChat();
            } else if (type === 'call') {
                startCall();
            }
        }

        function handoffToChat() {
            isHumanAgent = true;
            
            // Update header
            document.getElementById('agentAvatar').textContent = '👤';
            document.getElementById('agentName').textContent = 'Microsoft Support Agent';
            
            // Show handoff banner
            document.getElementById('handoffBanner').classList.add('active');
            
            // Add system message
            addSystemMessage('🔄 Connecting you to a support agent...');
            
            // Hide quick actions
            document.getElementById('quickActions').style.display = 'none';
            
            // Simulate agent joining
            setTimeout(() => {
                addMessage('Hello! I\'m Sarah, a Microsoft support specialist. I\'ve reviewed your conversation. How can I help you today?', 'human-agent', true);
            }, 2000);
        }

        function startCall() {
            const callScreen = document.getElementById('callScreen');
            callScreen.classList.add('active');
            
            // Simulate finding an agent
            setTimeout(() => {
                document.getElementById('callAgentName').textContent = 'Microsoft Support';
                document.getElementById('callStatus').textContent = 'Connecting call...';
                document.getElementById('callStatus').classList.remove('connecting');
            }, 2000);
            
            // Simulate call connecting
            setTimeout(() => {
                document.getElementById('callStatus').textContent = 'Connected';
                document.getElementById('callTimer').style.display = 'block';
                startCallTimer();
                
                // Add message to chat history
                addSystemMessage('📞 Voice call connected with Microsoft support agent');
            }, 4000);
        }

        function startCallTimer() {
            callDuration = 0;
            callTimer = setInterval(() => {
                callDuration++;
                const minutes = Math.floor(callDuration / 60).toString().padStart(2, '0');
                const seconds = (callDuration % 60).toString().padStart(2, '0');
                document.getElementById('callTimer').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        function toggleMute() {
            isMuted = !isMuted;
            const muteBtn = document.getElementById('muteBtn');
            muteBtn.textContent = isMuted ? '🔇' : '🎤';
            muteBtn.style.background = isMuted ? 'rgba(239, 68, 68, 0.8)' : 'rgba(255, 255, 255, 0.2)';
        }

        function endCall() {
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            const callScreen = document.getElementById('callScreen');
            callScreen.classList.remove('active');
            
            // Update chat to show human agent is now available for chat too
            isHumanAgent = true;
            document.getElementById('agentAvatar').textContent = '👤';
            document.getElementById('agentName').textContent = 'Microsoft Support Agent';
            document.getElementById('quickActions').style.display = 'none';
            
            // Add system message
            const minutes = Math.floor(callDuration / 60);
            const seconds = callDuration % 60;
            addSystemMessage(`📞 Call ended (Duration: ${minutes}m ${seconds}s). Support agent is still available via chat.`);
            
            setTimeout(() => {
                addMessage('Thanks for the call! Feel free to continue chatting here if you have any follow-up questions.', 'human-agent', true);
            }, 1000);
            
            // Reset call screen
            setTimeout(() => {
                document.getElementById('callAgentName').textContent = 'Connecting...';
                document.getElementById('callStatus').textContent = 'Finding available agent';
                document.getElementById('callStatus').classList.add('connecting');
                document.getElementById('callTimer').style.display = 'none';
                document.getElementById('callTimer').textContent = '00:00';
                isMuted = false;
                document.getElementById('muteBtn').textContent = '🎤';
                document.getElementById('muteBtn').style.background = 'rgba(255, 255, 255, 0.2)';
            }, 500);
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message === '') return;
            
            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Simulate bot response delay
            setTimeout(() => {
                hideTypingIndicator();
                
                if (isHumanAgent) {
                    // Human agent responses
                    const responses = [
                        'I understand your concern. Let me look into this for you right away.',
                        'That\'s a great question. Based on what you\'ve shared, here\'s what I can do...',
                        'I\'ve checked your account and I can help you with that. Here are your options...'
                    ];
                    addMessage(responses[Math.floor(Math.random() * responses.length)], 'human-agent', true);
                } else {
                    // Bot responses
                    const result = getBotResponse(message);
                    
                    // If searching website, show indicator first
                    if (result.searchWebsite) {
                        addSystemMessage('🔍 Searching microsoft.com/microsoft-365 for relevant information...', true);
                        setTimeout(() => {
                            addMessage('I found some general information. For specific inquiries about Microsoft 365 plans, features, pricing, or support, please ask me directly or I can connect you with a specialist.', 'bot', true);
                        }, 1500);
                    } else {
                        // Show website search indicator for website-sourced responses
                        if (result.fromWebsite) {
                            addSystemMessage('🔍 Retrieved from microsoft.com/microsoft-365', true);
                        }
                        addMessage(result.response, 'bot', true);
                        
                        if (result.salesHandoff) {
                            setTimeout(() => {
                                handoffToHuman();
                            }, 1500);
                        }
                    }
                }
            }, 1000 + Math.random() * 1000);
        }

        function sendQuickMessage(message) {
            document.getElementById('messageInput').value = message;
            sendMessage();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function giveFeedback(type) {
            const feedbackMessage = type === 'helpful' 
                ? 'Thank you for your feedback!' 
                : 'I\'m sorry I couldn\'t help better. Would you like to speak with a human agent?';
            
            setTimeout(() => {
                addMessage(feedbackMessage, 'bot');
            }, 300);
        }

        // Close modal when clicking outside
        document.getElementById('choiceModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeChoiceModal();
            }
        });

        document.getElementById('salesOptionsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSalesOptionsModal();
            }
        });

        document.getElementById('callbackFormModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCallbackFormModal();
            }
        });
    </script>
</body>
</html>